<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>4-Week Fat Loss Tracker</title>
  <meta name="description" content="A calm, nature‚Äëthemed habit tracker for workouts, dosing, water, and nutrition." />
  <meta name="theme-color" content="#5a7f71" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#0d1b16" media="(prefers-color-scheme: dark)">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="assets/icons/icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png">
  <style>
    :root{
      --bg:#f4f7f5; --card:#e7efe9; --accent:#5a7f71; --drop:#a8c8ba;
      --ink:#22302a; --muted:#5b6b64; --white:#fff; --success:#4ade80; --warning:#f59e0b;
      --shadow: 0 1px 0 rgba(0,0,0,.03);
      --shadow-hover: 0 4px 12px rgba(0,0,0,.1);
      --shadow-active: 0 2px 8px rgba(0,0,0,.15);
      --gradient-primary: linear-gradient(135deg, var(--accent) 0%, #4a9d7a 50%, var(--drop) 100%);
      --gradient-glass: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
      --safe-bottom: env(safe-area-inset-bottom);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0e1512; --card:#12211b; --accent:#8bd0b1; --drop:#3a6d5b;
        --ink:#ebf3f0; --muted:#a6bbb1; --white:#0e1512; --shadow: 0 1px 0 rgba(0,0,0,.2);
        --shadow-hover: 0 4px 16px rgba(0,0,0,.3);
        --shadow-active: 0 2px 12px rgba(0,0,0,.4);
        --gradient-glass: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
      }
      .tabbar{background:#0b100e;border-top-color:#1b2a24}
      .card,.timeline li{border-color:#1b2a24}
      .progress-bar{background:#1b2a24}
      
      /* Ensure all text is light in dark mode */
      body, h1, h2, h3, h4, h5, h6, p, span, div, label, button, input {
        color: var(--ink) !important;
      }
      
      /* Specific dark mode text overrides */
      .muted { color: var(--muted) !important; }
      .day-name, .task-time, .protein-ring-value { color: var(--accent) !important; }
      .btn.primary { color: #fff !important; }
      .btn { color: var(--ink) !important; }
      .exercise-name { color: var(--accent) !important; }
      .stat-number { color: var(--accent) !important; }
      
      /* Input fields in dark mode */
      .protein-input, .exercise-weight-input, .set-input, input[type="text"], input[type="number"], input[type="date"], input[type="time"] {
        background: var(--bg) !important;
        color: var(--ink) !important;
        border-color: var(--muted) !important;
      }
      
      /* Dialog backgrounds */
      dialog {
        background: var(--card) !important;
        color: var(--ink) !important;
      }
      
      /* Make sure placeholder text is visible */
      ::placeholder {
        color: var(--muted) !important;
        opacity: 0.8 !important;
      }
      
      /* Table text */
      .row div {
        color: var(--ink) !important;
      }
      
      /* Task text */
      .task-title, .task-note {
        color: var(--ink) !important;
      }
      .task-note {
        color: var(--muted) !important;
      }
    }
    
    /* Premium Animations & Transitions */
    *{box-sizing:border-box; transition: color 0.2s ease, background 0.2s ease, border-color 0.2s ease}
    html,body{height:100%}
    body{margin:0;font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;color:var(--ink);background:var(--bg)}
    
    /* Glass-morphism Effects */
    .glass-card {
      background: var(--gradient-glass);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    /* Enhanced Button Animations */
    .btn{
      background:none;border:1px solid color-mix(in oklab, black 8%, transparent); 
      padding:8px 12px; border-radius:10px; color:var(--ink);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-hover);
      border-color: color-mix(in oklab, var(--accent) 30%, transparent);
    }
    .btn:hover::before {
      left: 100%;
    }
    .btn:active {
      transform: translateY(0);
      box-shadow: var(--shadow-active);
    }
    
    .btn.primary{
      background:var(--gradient-primary); 
      border:none; 
      color:#fff;
      box-shadow: 0 2px 8px rgba(90, 127, 113, 0.3);
    }
    .btn.primary:hover {
      box-shadow: 0 4px 16px rgba(90, 127, 113, 0.4);
      transform: translateY(-2px);
    }
    .btn.primary:active {
      transform: translateY(-1px);
    }
    
    .btn.btn-success {
      background: var(--success) !important;
      color: white !important;
      border: none !important;
    }
    .btn.btn-success:hover {
      background: color-mix(in oklab, var(--success) 80%, black) !important;
      box-shadow: 0 4px 16px rgba(74, 222, 128, 0.4) !important;
    }
    
    .btn.ghost{border:none; color:var(--accent); font-weight:700; background:transparent}
    .btn.small{padding:4px 8px; font-size:0.8rem}
    .btn:focus-visible{outline:2px solid color-mix(in oklab, var(--accent) 70%, white); outline-offset:2px}
    
    /* Success Feedback Animation */
    @keyframes success-pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    .success-feedback {
      animation: success-pulse 0.3s ease;
    }
    
    /* Progress Animations */
    @keyframes progressFill {
      from { transform: scaleX(0); transform-origin: left; }
      to { transform: scaleX(1); transform-origin: left; }
    }
    .progress-fill {
      animation: progressFill 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Protein Ring Enhancement */
    @keyframes ringProgress {
      from { stroke-dasharray: 0 251.2; }
    }
    .protein-ring-progress {
      animation: ringProgress 1s ease-out;
      filter: drop-shadow(0 0 4px rgba(90, 127, 113, 0.3));
    }
    
    /* Floating Action Animations */
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-2px); }
    }
    .floating-element {
      animation: float 3s ease-in-out infinite;
    }
    
    /* Card Hover Effects */
    .card, .timeline li{
      background:var(--card); 
      border:1px solid color-mix(in oklab, black 8%, transparent); 
      border-radius:14px; padding:14px; margin:10px 4px; 
      box-shadow:var(--shadow);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .card:hover, .timeline li:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
      border-color: color-mix(in oklab, var(--accent) 20%, transparent);
    }
    
    .app-header{
      position:sticky; top:0; z-index:100; display:flex; justify-content:space-between; 
      align-items:center; gap:8px; padding:14px 16px; 
      background:linear-gradient(180deg, var(--card), color-mix(in oklab, var(--card) 70%, transparent)); 
      border-bottom:1px solid color-mix(in oklab, black 6%, transparent);
      backdrop-filter: blur(20px);
    }
    h1{margin:0; font-size:1.1rem}
    .muted{color:var(--muted)}
    .view{display:none; padding:12px 12px calc(84px + var(--safe-bottom))} .view.active{display:block}
    .day-header{display:flex; justify-content:space-between; align-items:center; margin:8px 4px 12px}
    .day-cluster{display:flex; flex-direction:column; gap:4px}
    .day-name{font-size:1.1rem; font-weight:800; color:var(--accent)} 
    .day-type{font-size:.92rem; color:var(--muted)} 
    .streak{
      font-size:.9rem; color:var(--accent); font-weight:700;
      padding: 4px 8px;
      background: color-mix(in oklab, var(--accent) 15%, transparent);
      border-radius: 12px;
      animation: float 2s ease-in-out infinite;
    }
    .picker{display:flex; gap:6px; flex-wrap:wrap}
    .chip{
      padding:6px 10px; border-radius:999px; 
      border:1px solid color-mix(in oklab, black 8%, transparent); 
      background:var(--card); font-size:.85rem; cursor:pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .chip:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .chip[aria-pressed="true"]{
      background:var(--gradient-primary); 
      color:#fff; border:none;
      box-shadow: 0 2px 8px rgba(90, 127, 113, 0.3);
    } 
    .today-chip{box-shadow:0 0 0 2px color-mix(in oklab, var(--accent) 50%, white)}
    .timeline{list-style:none; padding:0; margin:0}
    
    /* Enhanced Task Styling */
    .task{display:grid; grid-template-columns: 28px 1fr; align-items:start; gap:12px} 
    .task input[type="checkbox"]{
      width:22px;height:22px; accent-color:var(--accent); margin-top:2px;
      transition: transform 0.2s ease;
    }
    .task input[type="checkbox"]:checked {
      transform: scale(1.1);
    }
    .task label{display:block} 
    .task-time{
      font-weight:800; color:var(--accent); font-size:.95rem; margin-bottom:2px; 
      cursor:pointer; padding:2px 4px; border-radius:4px; 
      transition:all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .task-time:hover{
      background:color-mix(in oklab, var(--accent) 15%, transparent);
      transform: scale(1.02);
    }
    .task-title{font-weight:700; margin-bottom:2px} 
    .task-note{color:var(--muted); font-size:.9rem; line-height:1.4}
    .task-details{margin-top:8px; padding-top:8px; border-top:1px solid color-mix(in oklab, black 10%, transparent)} 
    .workout-details{
      background:color-mix(in oklab, var(--accent) 12%, transparent); 
      padding:10px; border-radius:8px;
      border-left: 3px solid var(--accent);
    }
    
    /* Enhanced Water Drops */
    .water{margin:18px 4px} 
    .water-head{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px} 
    .drops{display:flex; gap:6px; flex-wrap:wrap}
    .drop{
      width:24px; height:32px; border-radius:12px; 
      background:color-mix(in oklab, var(--accent) 15%, transparent); 
      border:1px solid color-mix(in oklab, black 8%, transparent); 
      cursor:pointer; position:relative; 
      transition:all .2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .drop:hover {
      transform: scale(1.1) translateY(-1px);
    }
    .drop.filled{
      background:var(--drop); 
      transform:scale(1.05);
      box-shadow: 0 2px 8px rgba(168, 200, 186, 0.4);
    } 
    .drop::after{
      content:""; position:absolute; top:6px; left:8px; width:8px; height:8px; 
      border-radius:50%; background:rgba(255,255,255,.9);
      transition: all 0.2s ease;
    }
    .drop.filled::after {
      animation: float 2s ease-in-out infinite;
    }
    
    .progress-bar{
      width:100%; height:8px; background:#dfe9e3; border-radius:6px; 
      overflow:hidden; margin-top:6px;
      position: relative;
    } 
    .progress-fill{
      height:100%; width:0; 
      background:linear-gradient(90deg, var(--accent), var(--success)); 
      transition:width .25s ease;
      position: relative;
    }
    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    /* Protein Goal Ring Enhancement */
    .protein-ring-container{
      position:relative; display:inline-flex; align-items:center; 
      justify-content:center; margin:18px 4px;
    }
    .protein-ring{width:80px; height:80px; position:relative}
    .protein-ring svg{width:100%; height:100%; transform:rotate(-90deg)}
    .protein-ring-bg{fill:none; stroke:color-mix(in oklab, var(--accent) 20%, transparent); stroke-width:6}
    .protein-ring-progress{
      fill:none; stroke:url(#proteinGradient); stroke-width:6; stroke-linecap:round; 
      transition:stroke-dasharray 0.3s ease;
      filter: drop-shadow(0 0 4px rgba(90, 127, 113, 0.3));
    }
    .protein-ring-center{
      position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); 
      text-align:center;
    }
    .protein-ring-value{
      font-size:0.9rem; font-weight:800; color:var(--accent);
      transition: all 0.3s ease;
    }
    .protein-ring-label{font-size:0.7rem; color:var(--muted)}
    .protein-input-container{display:flex; gap:8px; align-items:center; margin-top:8px}
    .protein-input{
      width:60px; padding:4px 6px; 
      border:1px solid color-mix(in oklab, black 10%, transparent); 
      border-radius:4px; background:var(--white); text-align:center;
      transition: all 0.2s ease;
    }
    .protein-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px color-mix(in oklab, var(--accent) 20%, transparent);
    }
    
    @media (prefers-reduced-motion: reduce){ 
      .drop, .progress-fill, .btn, .card, .chip, .task-time {transition:none} 
      .floating-element, .drop.filled::after {animation: none}
    }
    .stats-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin:10px 4px} 
    .stat-card{text-align:center} 
    .stat-number{
      font-size:1.4rem; font-weight:800; color:var(--accent);
      transition: all 0.3s ease;
    }
    .stat-card:hover .stat-number {
      transform: scale(1.1);
      color: var(--success);
    }
    
    .tabbar{
      position:fixed; inset-inline:0; bottom:0; z-index:101; display:flex; 
      background:var(--card); border-top:1px solid color-mix(in oklab, black 8%, transparent); 
      padding-bottom:var(--safe-bottom);
      backdrop-filter: blur(20px);
    }
    @media (prefers-color-scheme: dark){ 
      .tabbar{background:#0b100e} 
    }
    .tabbar button{
      flex:1; padding:12px 8px; background:none; border:none; 
      color:var(--muted); font-weight:700; font-size:.85rem;
      transition: all 0.2s ease;
      position: relative;
    } 
    .tabbar button:hover {
      color: var(--accent);
      background: color-mix(in oklab, var(--accent) 8%, transparent);
    }
    .tabbar button.active{
      color:var(--accent);
    }
    .tabbar button.active::after {
      content: '';
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 20px;
      height: 2px;
      background: var(--accent);
      border-radius: 2px;
    }
    
    /* Dialog styles */
    dialog{border:none; border-radius:14px; overflow:hidden; background:var(--card); color:var(--ink)} 
    dialog::backdrop{background:rgba(0,0,0,0.5)}
    dialog form{padding:16px} 
    #timeForm .row{display:grid; grid-template-columns: 1fr 120px; gap:8px; margin:6px 0}
    .today-highlight{outline:2px solid color-mix(in oklab, var(--accent) 60%, white); border-radius:12px; box-shadow:0 0 0 4px color-mix(in oklab, var(--accent) 12%, transparent) inset}

    /* Enhanced Exercise Logging */
    .exercise-log{margin:12px 4px}
    .exercise-log-simple{margin:8px 0}
    .exercise-entry{background:var(--card); border:1px solid color-mix(in oklab, black 8%, transparent); border-radius:12px; padding:12px; margin:8px 0}
    .exercise-entry-simple{display:grid; grid-template-columns:1fr 100px 60px; gap:8px; align-items:center; background:var(--card); border:1px solid color-mix(in oklab, black 8%, transparent); border-radius:8px; padding:8px; margin:4px 0}
    .exercise-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px}
    .exercise-name{font-weight:700; color:var(--accent)}
    .exercise-weight-input{padding:6px; border:1px solid color-mix(in oklab, black 10%, transparent); border-radius:6px; background:var(--white); text-align:center; width:100%}
    .pr-badge{background:color-mix(in oklab, var(--success) 20%, transparent); color:var(--success); padding:2px 6px; border-radius:999px; font-size:0.7rem; font-weight:700}
    .sets-container{display:grid; gap:6px}
    .set-row{display:grid; grid-template-columns:40px 1fr 1fr 1fr 40px; gap:8px; align-items:center; padding:4px 0}
    .set-input{padding:6px; border:1px solid color-mix(in oklab, black 10%, transparent); border-radius:6px; background:var(--white); text-align:center; width:100%}
    .add-set-btn{grid-column:1/-1; margin-top:8px}
    .remove-set-btn{background:none; border:none; color:var(--warning); cursor:pointer; font-size:1.2rem; display:flex; align-items:center; justify-content:center}
    .today-exercises{display:grid; gap:6px; margin-top:8px}
    .today-exercise-item{display:flex; justify-content:space-between; align-items:center; padding:6px 10px; background:color-mix(in oklab, var(--accent) 8%, transparent); border-radius:6px; font-size:0.9rem}
    .quick-add-container{display:flex; gap:6px; margin-top:8px}
    
    /* Enhanced Workout Styles */
    .structured-workout{display:grid; gap:10px; margin-top:8px}
    .workout-row{
      display:grid; gap:8px; align-items:center;
      padding:10px; background:color-mix(in oklab, var(--accent) 5%, transparent); 
      border-radius:8px; transition: all 0.2s ease;
    }
    
    /* Different grid layouts for different workout types */
    .workout-row.strength {
      grid-template-columns: 1fr 80px 60px; /* Exercise, Weight, Save indicator */
    }
    .workout-row.hiit, .workout-row.cardio {
      grid-template-columns: 1fr 100px 60px; /* Exercise, Time (mm:ss), Save indicator */
    }
    .workout-row.core {
      grid-template-columns: 1fr 80px 60px; /* Exercise, Reps, Save indicator */
    }
    .workout-row.recovery, .workout-row.rest {
      grid-template-columns: 1fr 80px; /* Exercise, Checkbox */
    }
    
    .workout-row:hover {
      background:color-mix(in oklab, var(--accent) 8%, transparent);
    }
    .workout-row.completed {
      background:color-mix(in oklab, var(--success) 10%, transparent);
      border-left: 3px solid var(--success);
    }
    .exercise-select{
      padding:6px 8px; border:1px solid color-mix(in oklab, black 10%, transparent); 
      border-radius:6px; background:var(--white); font-size:0.9rem;
      transition: all 0.2s ease; width: 100%;
    }
    .exercise-select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px color-mix(in oklab, var(--accent) 20%, transparent);
    }
    .metric-input{
      padding:6px 8px; border:1px solid color-mix(in oklab, black 10%, transparent); 
      border-radius:6px; background:var(--white); text-align:center; 
      font-size:0.9rem; transition: all 0.2s ease; width: 100%;
    }
    .metric-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px color-mix(in oklab, var(--accent) 20%, transparent);
    }
    .save-indicator{
      font-size:0.75rem; color:var(--success); font-weight:600;
      opacity: 0; transition: opacity 0.3s ease;
    }
    .save-indicator.show {
      opacity: 1;
    }
    .pr-indicator{
      background:var(--gradient-primary); color:white; 
      padding:2px 6px; border-radius:12px; font-size:0.7rem; font-weight:600;
      animation: bounce 0.5s ease;
    }
    
    /* Dark mode fixes for selects and inputs */
    @media (prefers-color-scheme: dark) {
      .exercise-select, .metric-input {
        background: var(--bg) !important;
        color: var(--ink) !important;
        border-color: var(--muted) !important;
      }
      .exercise-select option {
        background: var(--bg) !important;
        color: var(--ink) !important;
      }
    }
    
    /* Achievement Badges */
    .achievement-badge{
      display:inline-flex; align-items:center; gap:4px;
      background:var(--gradient-primary); color:white; 
      padding:4px 8px; border-radius:12px; font-size:0.75rem; font-weight:600;
      box-shadow: 0 2px 4px rgba(90, 127, 113, 0.3);
      animation: bounce 0.5s ease;
    }
    
    @keyframes bounce {
      0%, 20%, 60%, 100% { transform: translateY(0); }
      40% { transform: translateY(-4px); }
      80% { transform: translateY(-2px); }
    }

    /* Resources table */
    .resource-section{margin:12px 4px}
    .table{display:grid; gap:6px} .row{display:grid; grid-template-columns: 110px 1fr 90px 140px 1fr; gap:6px}
    .row div{background:var(--card); border:1px solid color-mix(in oklab, black 8%, transparent); border-radius:10px; padding:10px; text-align:center} .row.head div{font-weight:800}
    @media (max-width: 480px){ .row{grid-template-columns: 90px 1fr;} .row div:nth-child(n+3){display:none} }

    /* Log form */
    .form{display:grid; gap:10px; margin:8px 4px}
    .field{display:grid; grid-template-columns: 1fr 120px; align-items:center; gap:8px; background:var(--card); border:1px solid color-mix(in oklab, black 8%, transparent); border-radius:12px; padding:10px}
    .field input{width:100%; padding:8px; border-radius:8px; border:1px solid color-mix(in oklab, black 10%, transparent); background:var(--white); color:var(--ink)}
    .field small{color:var(--muted)}
    .form h3{margin:6px 4px}
    .grid-2{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .badge{display:inline-block; padding:3px 8px; border-radius:999px; background:var(--card); border:1px solid color-mix(in oklab, black 8%, transparent); color:var(--muted); font-size:.8rem}
    .pill{display:inline-block; padding:4px 8px; border-radius:999px; background:color-mix(in oklab, var(--accent) 15%, transparent); color:var(--accent); font-weight:700; font-size:.8rem}
    .section-title{display:flex; justify-content:space-between; align-items:center; gap:8px; margin:10px 4px}
    canvas{width:100%; height:200px; background:var(--card); border:1px solid color-mix(in oklab, black 8%, transparent); border-radius:12px}
    
    /* PR Display */
    .pr-display{margin:12px 4px}
    .pr-grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:8px}
    .pr-card{background:var(--card); border:1px solid color-mix(in oklab, black 8%, transparent); border-radius:12px; padding:12px; text-align:center}
    .pr-lift{font-size:0.8rem; color:var(--muted); margin-bottom:4px}
    .pr-value{font-size:1.2rem; font-weight:800; color:var(--accent)}
    .pr-date{font-size:0.7rem; color:var(--muted); margin-top:4px}
    
    /* Day Change Detection Indicator */
    .day-change-indicator {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--gradient-primary);
      color: white;
      padding: 20px;
      border-radius: 16px;
      z-index: 1000;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .day-change-indicator.show {
      opacity: 1;
    }
  </style>
</head>
<body>
  <header class="app-header" role="banner">
    <h1>Health & Fitness Tracker</h1>
    <div class="picker" role="tablist" aria-label="Pick a day to preview">
      <button class="chip" data-day="0" aria-pressed="false" aria-label="Sunday">Sun</button>
      <button class="chip" data-day="1" aria-pressed="false" aria-label="Monday">Mon</button>
      <button class="chip" data-day="2" aria-pressed="false" aria-label="Tuesday">Tue</button>
      <button class="chip" data-day="3" aria-pressed="false" aria-label="Wednesday">Wed</button>
      <button class="chip" data-day="4" aria-pressed="false" aria-label="Thursday">Thu</button>
      <button class="chip" data-day="5" aria-pressed="false" aria-label="Friday">Fri</button>
      <button class="chip" data-day="6" aria-pressed="false" aria-label="Saturday">Sat</button>
    </div>
  </header>

  <!-- Today View -->
  <main id="view-today" class="view active" role="main">
    <div class="day-header" aria-live="polite">
      <div class="day-cluster">
        <div class="day-name" id="dayName">Monday</div>
        <div class="day-type" id="dayType">Full Body Strength ‚Ä¢ Dose day</div>
        <div class="muted" id="weekLabel">Week 1</div>
      </div>
      <div class="streak" aria-label="Current streak"><span aria-hidden="true">üî•</span> <span id="streakCount">0</span> day streak</div>
    </div>

    <ul id="timeline" class="timeline" aria-label="Today timeline"></ul>

    <section class="water" aria-labelledby="waterHeading">
      <div class="water-head">
        <h2 id="waterHeading">Hydration</h2>
        <div class="muted"><span id="waterCurrent" aria-live="polite">0</span>/8 glasses</div>
      </div>
      <div id="waterDrops" class="drops" role="group" aria-label="Water cups"></div>
      <div class="progress-bar" aria-hidden="true"><div id="waterProgress" class="progress-fill"></div></div>
      <div class="quick-add-container" style="display:flex; gap:6px; margin-top:8px; justify-content:center">
        <button class="btn small" onclick="addQuickWater(1)">+1 glass</button>
        <button class="btn small" onclick="addQuickWater(2)">+2 glasses</button>
        <button class="btn small" onclick="addQuickWater(-1)">-1 glass</button>
      </div>
    </section>

    <section class="protein-ring-container" aria-labelledby="proteinHeading">
      <div class="protein-ring">
        <svg viewBox="0 0 100 100">
          <defs>
            <linearGradient id="proteinGradient" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" style="stop-color:var(--accent);stop-opacity:1" />
              <stop offset="100%" style="stop-color:var(--success);stop-opacity:1" />
            </linearGradient>
          </defs>
          <circle class="protein-ring-bg" cx="50" cy="50" r="40"></circle>
          <circle class="protein-ring-progress" cx="50" cy="50" r="40" id="proteinProgressRing"></circle>
        </svg>
        <div class="protein-ring-center">
          <div class="protein-ring-value" id="proteinCurrent">0</div>
          <div class="protein-ring-label">protein</div>
        </div>
      </div>
      <div>
        <h3 id="proteinHeading" style="margin:0 0 4px; font-size:1rem">Protein Goal</h3>
        <div class="protein-input-container">
          <input type="number" id="proteinGoalInput" class="protein-input" placeholder="Goal" min="50" max="300" step="5">
          <button class="btn small" onclick="updateProteinGoal()">Set</button>
        </div>
        <div class="muted" style="font-size:0.8rem; margin-top:4px">
          <span id="proteinGoalText">Set your daily goal</span>
        </div>
        <div class="quick-add-container" style="display:flex; gap:6px; margin-top:8px; flex-wrap:wrap">
          <button class="btn small" onclick="addQuickProtein(20)">+20g</button>
          <button class="btn small" onclick="addQuickProtein(25)">+25g</button>
          <button class="btn small" onclick="addQuickProtein(30)">+30g</button>
          <button class="btn small" onclick="addQuickProtein(40)">+40g</button>
        </div>
      </div>
    </section>

    <section class="card" style="margin:18px 4px">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
        <h3 style="margin:0">Today's Workout</h3>
        <span id="workoutType" class="muted" style="font-size:0.85rem"></span>
      </div>
      <div id="workoutSection" class="structured-workout"></div>
    </section>
  </main>

  <!-- Week View -->
  <main id="view-week" class="view">
    <div class="stats-grid" aria-label="Weekly stats">
      <div class="card stat-card"><div class="stat-number" id="weekCompleted">0</div><div class="muted">Days Completed</div></div>
      <div class="card stat-card"><div class="stat-number" id="weekPercentage">0%</div><div class="muted">Week Progress</div></div>
    </div>
    
    <!-- Weekly Body Metrics -->
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
        <h3 style="margin:0">Weekly Body Metrics</h3>
        <div class="muted" style="font-size:0.8rem">Sunday Morning Task</div>
      </div>
      <div class="form" style="margin:0">
        <div class="grid-2" style="gap:8px">
          <div class="field" style="padding:8px"><label for="weeklyWeight">Weight (lb)</label><input id="weeklyWeight" type="number" step="0.1" inputmode="decimal"></div>
          <div class="field" style="padding:8px"><label for="weeklyWaist">Waist (in)</label><input id="weeklyWaist" type="number" step="0.1" inputmode="decimal"></div>
        </div>
        <div class="field" style="padding:8px; grid-column:1/-1"><label for="weeklyHips">Hips (in)</label><input id="weeklyHips" type="number" step="0.1" inputmode="decimal"></div>
        <button id="saveWeeklyMetrics" class="btn primary" style="margin-top:8px">Save Metrics</button>
      </div>
    </div>
    
    <div id="weekOverview" class="timeline"></div>
    <div class="card">
      <h2>Weekly Schedule</h2>
      <div id="weekSchedule"></div>
    </div>
    <button id="resetWeekBtn" class="btn" style="margin:12px 4px">Reset Week</button>
  </main>

  <!-- Resources -->
  <main id="view-resources" class="view">
    <section class="card resource-section">
      <h2>Weekly Training Schedule</h2>
      <p><strong>Legend:</strong> üèã Strength ‚Ä¢ ‚ö° HIIT ‚Ä¢ üö∂ Active Recovery ‚Ä¢ ‚ùå Rest</p>
      <div class="table">
        <div class="row head"><div>Day</div><div>Training</div><div>Sermorelin</div><div>Cardio</div><div>Nutrition Focus</div></div>
        <div class="row"><div>Mon üèã</div><div>Full Body Strength</div><div>‚úî</div><div>‚Äî</div><div>Mod carbs post‚Äëworkout</div></div>
        <div class="row"><div>Tue ‚ö°</div><div>HIIT + Core</div><div>‚úî</div><div>‚Äî</div><div>Low carb PM</div></div>
        <div class="row"><div>Wed üèã</div><div>Upper Strength + Cardio</div><div>‚úî</div><div>20 min steady</div><div>Mod carbs post‚Äëworkout</div></div>
        <div class="row"><div>Thu ‚ö°</div><div>HIIT</div><div>‚úî</div><div>‚Äî</div><div>Low carb PM</div></div>
        <div class="row"><div>Fri üèã</div><div>Lower Strength + Cardio</div><div>‚úî</div><div>20‚Äì30 min steady</div><div>Mod carbs post‚Äëworkout</div></div>
        <div class="row"><div>Sat üö∂</div><div>Active Recovery</div><div>‚ùå</div><div>Fasted walk</div><div>Low carb day</div></div>
        <div class="row"><div>Sun ‚ùå</div><div>Rest</div><div>‚ùå</div><div>Light walk optional</div><div>Low carb day</div></div>
      </div>
    </section>

    <section class="card resource-section">
      <h2>üèãÔ∏è Workout Structure & Guidelines</h2>
      
      <h3>üí™ Strength Days (Mon/Wed/Fri):</h3>
      <ul>
        <li><strong>Metric:</strong> Weight in pounds</li>
        <li>3 sets √ó 8-12 reps</li>
        <li>60-90 seconds rest between sets</li>
        <li>2-3 minutes rest between exercises</li>
        <li>Focus: Progressive overload each week</li>
      </ul>

      <h3>‚ö° HIIT Days (Tue/Thu):</h3>
      <ul>
        <li><strong>Metric:</strong> Time duration (minutes)</li>
        <li>Work intervals: 15-30 seconds all-out</li>
        <li>Rest intervals: 30-60 seconds active recovery</li>
        <li>Total time: 15-20 minutes</li>
        <li>Focus: Maximum effort during work periods</li>
      </ul>

      <h3>üíØ Core Exercises:</h3>
      <ul>
        <li><strong>Metric:</strong> Total reps completed</li>
        <li>Focus on form over speed</li>
        <li>Control the movement</li>
        <li>Progressive rep increases</li>
      </ul>

      <h3>üö∂ Recovery Days (Sat/Sun):</h3>
      <ul>
        <li><strong>Metric:</strong> Simple completion checkmark</li>
        <li>Low intensity, 20-30 minutes</li>
        <li>Focus: Movement and mobility</li>
        <li>Listen to your body</li>
      </ul>
    </section>

    <section class="card resource-section">
      <h2>üßò Pre-Workout Mobility (5-10 minutes)</h2>
      
      <h3>For All Days:</h3>
      <ul>
        <li>Arm circles (10 each direction)</li>
        <li>Leg swings (10 each leg, front/back and side)</li>
        <li>Squat rotations (10 each direction)</li>
        <li>Squat internal rotations (10 each side)</li>
        <li>Squat toe raises (10 reps)</li>
        <li>Hami extensions (10 reps)</li>
        <li>Straddle rotations (10 each direction)</li>
        <li>Cat-cow stretches (10 reps)</li>
      </ul>

      <h3>Strength Days Add:</h3>
      <ul>
        <li>Hip CARs (5 each direction)</li>
        <li>Bodyweight squats (10 reps)</li>
        <li>Push-ups or wall push-ups (5-10 reps)</li>
        <li>Shoulder dislocations with band (10 reps)</li>
        <li>Glute bridges (10 reps)</li>
      </ul>

      <h3>HIIT Days Add:</h3>
      <ul>
        <li>Floor scorpion bridge (5 each side)</li>
        <li>Jumping jacks (20 reps)</li>
        <li>High knees (20 reps)</li>
        <li>Butt kicks (20 reps)</li>
        <li>Dynamic stretches (leg swings, arm swings)</li>
      </ul>
    </section>

    <section class="card resource-section">
      <h2>üçΩÔ∏è Nutrition Guidelines & Meal Planning</h2>
      
      <h3>Target Macros by Meal Type:</h3>
      
      <h4>Post-Workout (Within 1 hour):</h4>
      <ul>
        <li><strong>Protein:</strong> 25-30g</li>
        <li><strong>Carbs:</strong> 20-30g</li>
        <li><em>Example:</em> Protein shake + banana</li>
      </ul>

      <h4>Lunch (Moderate carb days):</h4>
      <ul>
        <li><strong>Protein:</strong> 30-40g</li>
        <li><strong>Carbs:</strong> 30-45g</li>
        <li><em>Example:</em> 6oz chicken + 1 cup rice + vegetables</li>
      </ul>

      <h4>Dinner (Low carb focus):</h4>
      <ul>
        <li><strong>Protein:</strong> 30-40g</li>
        <li><strong>Carbs:</strong> 15-25g</li>
        <li><em>Example:</em> 6oz salmon + asparagus + olive oil</li>
      </ul>

      <h4>Snacks:</h4>
      <ul>
        <li><strong>Protein:</strong> 15-25g</li>
        <li><strong>Carbs:</strong> 10-20g (if needed)</li>
      </ul>

      <h3>Protein Options by Macro Range:</h3>
      
      <h4>High Protein Snacks (20-25g):</h4>
      <ul>
        <li>Whey isolate (110‚Äì130 cal, 25g protein) with water or unsweetened almond milk</li>
        <li>Greek yogurt (150g, 100 cal, 18g protein) + protein powder</li>
        <li>Cottage cheese (¬Ω cup, 90 cal, 14g protein) + protein powder</li>
        <li>Protein bars (aim for 20-25g protein, &lt;8g sugar)</li>
      </ul>

      <h4>Moderate Protein Snacks (15-20g):</h4>
      <ul>
        <li>Greek yogurt (150g, 18g protein) + cinnamon</li>
        <li>Turkey or chicken slices (3oz, 21g protein) with mustard</li>
        <li>Hard-boiled eggs (2 large, 12g protein) + string cheese</li>
        <li>Cottage cheese (¬Ω cup, 14g protein) with berries</li>
      </ul>

      <h3>Breakfast Ideas (25-30g protein, 20-30g carbs):</h3>
      <ul>
        <li>2 eggs + 3 egg whites + ¬Ω banana</li>
        <li>Protein shake + small handful of berries</li>
        <li>Greek yogurt + chia seeds + blueberries + protein powder</li>
      </ul>

      <h3>Lunch Ideas (30-40g protein, 30-45g carbs):</h3>
      <ul>
        <li>6oz chicken breast + 1 cup quinoa + roasted veggies</li>
        <li>6oz salmon + medium sweet potato + spinach</li>
        <li>6oz lean ground turkey + 1 cup brown rice + broccoli</li>
      </ul>

      <h3>Dinner Ideas (30-40g protein, 15-25g carbs):</h3>
      <ul>
        <li>6oz grilled chicken + asparagus + olive oil</li>
        <li>6oz white fish + zucchini noodles + pesto</li>
        <li>6oz lean steak + roasted Brussels sprouts + avocado</li>
      </ul>
    </section>
  </main>

  <!-- Log -->
  <main id="view-log" class="view">
    <div class="section-title">
      <h2>Daily Log</h2>
      <button id="saveLogBtn" class="btn primary">Save</button>
    </div>
    <div class="form" aria-label="Daily measurements and habits">
      <div class="grid-2">
        <div class="field"><label for="logDate">Date</label><input id="logDate" type="date"></div>
        <div class="field"><label for="logProtein">Protein (g)</label><input id="logProtein" type="number" step="1" inputmode="numeric"></div>
      </div>
      <div class="grid-2">
        <div class="field"><label for="logSleep">Sleep (hrs)</label><input id="logSleep" type="number" step="0.1" inputmode="decimal"></div>
        <div class="field"><label for="logSteps">Steps</label><input id="logSteps" type="number" step="1" inputmode="numeric"></div>
      </div>
      <div class="field"><label for="logMood">Mood / Energy (1‚Äì5)</label><input id="logMood" type="number" min="1" max="5" step="1" inputmode="numeric"></div>

      <h3>Exercise Max Weight Log</h3>
      <div id="exerciseLog" class="exercise-log-simple"></div>
      <button id="addExerciseBtn" class="btn" style="margin:8px 0">Add Exercise</button>
    </div>

    <div class="section-title">
      <h2>Backup</h2>
      <div>
        <button id="exportBtn" class="btn">Export</button>
        <label class="btn" style="cursor:pointer">
          Import <input id="importInput" type="file" accept="application/json" style="display:none">
        </label>
      </div>
    </div>
    <p class="muted" style="margin:0 4px 8px">Export creates a JSON backup of all your app data (schedule, checks, logs). Import restores it.</p>
  </main>

  <!-- Progress -->
  <main id="view-progress" class="view">
    <div class="section-title">
      <h2>Progress</h2>
      <span id="progressBadges"></span>
    </div>

    <div class="pr-display">
      <h3>Personal Records</h3>
      <div id="prGrid" class="pr-grid"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px">Weight Trend</h3>
      <canvas id="chartWeight" width="400" height="220" aria-label="Weight chart"></canvas>
      <div class="muted" style="margin-top:6px"><span class="badge" id="weightChange">‚Äî</span></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px">Waist Trend</h3>
      <canvas id="chartWaist" width="400" height="220" aria-label="Waist chart"></canvas>
      <div class="muted" style="margin-top:6px"><span class="badge" id="waistChange">‚Äî</span></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px">Weekly Summary</h3>
      <div class="grid-2">
        <div><div class="pill" id="sumWorkouts">‚Äî</div><small class="muted">Workouts completed</small></div>
        <div><div class="pill" id="sumProtein">‚Äî</div><small class="muted">Avg protein/day</small></div>
        <div><div class="pill" id="sumSleep">‚Äî</div><small class="muted">Avg sleep (hrs)</small></div>
        <div><div class="pill" id="sumWater">‚Äî</div><small class="muted">Avg water (glasses)</small></div>
      </div>
    </div>
  </main>

  <nav class="tabbar" role="navigation" aria-label="App tabs">
    <button data-target="view-today" class="active" aria-controls="view-today" aria-selected="true">Today</button>
    <button data-target="view-week" aria-controls="view-week" aria-selected="false">Week</button>
    <button data-target="view-resources" aria-controls="view-resources" aria-selected="false">Resources</button>
    <button data-target="view-log" aria-controls="view-log" aria-selected="false">Log</button>
    <button data-target="view-progress" aria-controls="view-progress" aria-selected="false">Progress</button>
  </nav>

  <!-- Time Edit Dialog -->
  <dialog id="timeEditDialog">
    <form method="dialog">
      <h3>Edit Time</h3>
      <div class="row">
        <label for="timeInput">Time:</label>
        <input id="timeInput" type="time" required>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:16px">
        <button type="button" class="btn" onclick="closeTimeDialog()">Cancel</button>
        <button type="submit" class="btn primary">Save</button>
      </div>
    </form>
  </dialog>

  <!-- Exercise Dialog -->
  <dialog id="exerciseDialog">
    <form method="dialog">
      <h3>Add Exercise</h3>
      <div class="row">
        <label for="exerciseNameInput">Exercise:</label>
        <input id="exerciseNameInput" type="text" required placeholder="e.g., Bench Press">
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:16px">
        <button type="button" class="btn" onclick="closeExerciseDialog()">Cancel</button>
        <button type="submit" class="btn primary">Add</button>
      </div>
    </form>
  </dialog>

  <!-- Day Change Indicator -->
  <div id="dayChangeIndicator" class="day-change-indicator">
    <h3 style="margin: 0 0 8px;">üåÖ New Day!</h3>
    <p style="margin: 0;">Your progress has been reset for today.<br>Let's make it a great day!</p>
  </div>

  <script>
    // Define exercise data with workout types
    const WORKOUT_EXERCISES = {
      0: [ // Sunday - Rest
        { category: "Light Movement", options: ["Gentle Walk", "Stretching", "Tai Chi", "Restorative Yoga"], type: "rest" },
        { category: "Recovery", options: ["Meditation", "Breathing Work", "Self-Massage", "Sauna/Bath"], type: "rest" },
        { category: "Leisure", options: ["Reading", "Hobbies", "Social Time", "Nature Walk"], type: "rest" }
      ],
      1: [ // Monday - Full Body Strength
        { category: "Primary Squat", options: ["Back Squat", "Front Squat", "Goblet Squat", "Bulgarian Split Squat"], type: "strength" },
        { category: "Primary Push", options: ["Bench Press", "Dumbbell Press", "Incline Press", "Push-ups"], type: "strength" },
        { category: "Primary Pull", options: ["Bent-Over Row", "T-Bar Row", "One-Arm DB Row", "Cable Row"], type: "strength" },
        { category: "Hip Hinge", options: ["Romanian Deadlift", "Hip Thrusts", "Kettlebell Swings", "Good Mornings"], type: "strength" },
        { category: "Overhead", options: ["Overhead Press", "Arnold Press", "Pike Push-ups", "Landmine Press"], type: "strength" },
        { category: "Core", options: ["Plank Hold", "Dead Bug", "Pallof Press", "Bird Dog"], type: "core" }
      ],
      2: [ // Tuesday - HIIT + Core
        { category: "HIIT Cardio", options: ["Sprint Intervals", "Battle Ropes", "Burpees", "High Knees"], type: "hiit" },
        { category: "Core Flexion", options: ["Hanging Knee Raises", "Leg Raises", "V-ups", "Bicycle Crunches"], type: "core" },
        { category: "Anti-Extension", options: ["Plank", "Dead Bug", "Ab Wheel", "Hollow Hold"], type: "core" },
        { category: "Core Rotation", options: ["Russian Twists", "Wood Chops", "Cable Twists", "Medicine Ball Slams"], type: "core" },
        { category: "Anti-Lateral", options: ["Side Plank", "Suitcase Carry", "Single-Arm Farmer's Walk", "Pallof Press"], type: "core" }
      ],
      3: [ // Wednesday - Upper Strength
        { category: "Primary Pull", options: ["Pull-ups", "Lat Pulldown", "Cable Row", "Chest-Supported Row"], type: "strength" },
        { category: "Primary Push", options: ["Incline Press", "Overhead Press", "Dips", "Close-Grip Bench"], type: "strength" },
        { category: "Pull Isolation", options: ["Face Pulls", "Reverse Flyes", "Shrugs", "Cable Pull-aparts"], type: "strength" },
        { category: "Push Isolation", options: ["Lateral Raises", "Tricep Extensions", "Chest Flyes", "Front Raises"], type: "strength" },
        { category: "Arms", options: ["Bicep Curls", "Hammer Curls", "Tricep Dips", "Cable Curls"], type: "strength" },
        { category: "Cardio", options: ["20min Rowing", "Bike", "Incline Walk", "Elliptical"], type: "cardio" }
      ],
      4: [ // Thursday - HIIT
        { category: "Power", options: ["Jump Squats", "Box Jumps", "Explosive Push-ups", "Burpee Broad Jumps"], type: "hiit" },
        { category: "Cardio", options: ["High Knees", "Jumping Jacks", "Sprint Intervals", "Mountain Climbers"], type: "hiit" },
        { category: "Strength", options: ["Thrusters", "Man Makers", "Turkish Get-ups", "Kettlebell Swings"], type: "hiit" },
        { category: "Finisher", options: ["Plank Jacks", "Bear Crawls", "Jump Rope", "Burpee Ladder"], type: "hiit" }
      ],
      5: [ // Friday - Lower Strength
        { category: "Hip Hinge", options: ["Deadlift", "Romanian Deadlift", "Trap Bar Deadlift", "Sumo Deadlift"], type: "strength" },
        { category: "Squat", options: ["Back Squat", "Front Squat", "Hack Squat", "Leg Press"], type: "strength" },
        { category: "Unilateral", options: ["Walking Lunges", "Bulgarian Split Squats", "Single-Leg RDL", "Step-ups"], type: "strength" },
        { category: "Glutes", options: ["Hip Thrusts", "Glute Bridges", "Clamshells", "Cable Kickbacks"], type: "strength" },
        { category: "Calves", options: ["Standing Calf Raises", "Seated Calf Raises", "Calf Press", "Jump Rope"], type: "strength" },
        { category: "Cardio", options: ["20-30min Stair Climber", "Bike", "Incline Walk", "Rowing"], type: "cardio" }
      ],
      6: [ // Saturday - Active Recovery
        { category: "Light Cardio", options: ["20-30min Walk", "Easy Bike", "Swimming", "Yoga Flow"], type: "recovery" },
        { category: "Mobility", options: ["Stretching Session", "Foam Rolling", "Yoga", "Pilates"], type: "recovery" },
        { category: "Stability", options: ["Balance Work", "Light Core", "Breathing Exercises", "Meditation"], type: "recovery" },
        { category: "Optional", options: ["Recreational Activity", "Light Sports", "Dancing", "Hiking"], type: "recovery" }
      ]
    };

    const WEEKLY_SCHEDULE = {
      0:{type:"Rest Day",workoutType:"rest",dose:false,schedule:[
        {key:"hydrate",time:"08:00",title:"Wake & Hydrate",note:"16‚Äì20 oz water"},
        {key:"activity",time:"09:00",title:"Light Activity",note:"Light mobility or leisure activity"},
        {key:"breakfast",time:"09:30",title:"Breakfast",note:"Protein + fats"},
        {key:"lunch",time:"12:30",title:"Lunch",note:"Protein + greens (low carb)"},
        {key:"dinner",time:"18:00",title:"Dinner",note:"Protein + veggies (low carb)"},
        {key:"sleep",time:"22:00",title:"Wind Down",note:"No food 2 hrs before bed"}
      ]},
      1:{type:"Full Body Strength",workoutType:"strength",dose:true,schedule:[
        {key:"hydrate",time:"06:15",title:"Wake & Hydrate",note:"16‚Äì20 oz water"},
        {key:"workout",time:"06:30",title:"Full Body Workout",note:"45‚Äì60 min strength",details:"Barbell Back Squat ‚Üí alt: Goblet Squat; Bench Press ‚Üí alt: DB Chest; Bent‚ÄëOver Row ‚Üí alt: 1‚ÄëArm DB Row; Seated OHP ‚Üí alt: Arnold Press; RDL ‚Üí alt: Kettlebell Deadlift; Plank 3√ó30‚Äì60s ‚Üí alt: Dead Bug"},
        {key:"postwo",time:"07:45",title:"Post‚ÄëWorkout",note:"25‚Äì30g protein + small carbs (banana/berries)"},
        {key:"snack1",time:"10:30",title:"Snack",note:"Protein + fats (turkey + avocado)"},
        {key:"lunch",time:"13:00",title:"Lunch",note:"Lean protein + moderate carbs + veggies"},
        {key:"snack2",time:"16:30",title:"Snack",note:"Protein + veggies or nuts"},
        {key:"dinner",time:"19:00",title:"Dinner",note:"Protein + low‚Äëcarb veggies + healthy fats"},
        {key:"cutoff",time:"21:45",title:"Food Cutoff",note:"No food after this time"},
        {key:"dose",time:"22:30",title:"Sermorelin 40 mg",note:""},
        {key:"sleep",time:"22:35",title:"Sleep",note:""}
      ]},
      2:{type:"HIIT + Core",workoutType:"hiit",dose:true,schedule:[
        {key:"hydrate",time:"06:15",title:"Wake & Hydrate",note:"16‚Äì20 oz water"},
        {key:"workout",time:"06:30",title:"HIIT + Core",note:"15‚Äì20 min HIIT + core",details:"Sprints 20s all‚Äëout / 40s rest √ó 8‚Äì10 ‚Ä¢ Core: Knee Raises √ó12, Russian Twists √ó20, Side Plank √ó30s/side"},
        {key:"postwo",time:"06:55",title:"Post‚ÄëWorkout",note:"Protein + small carbs"},
        {key:"snack1",time:"10:00",title:"Snack",note:"Protein + fats"},
        {key:"lunch",time:"13:00",title:"Lunch",note:"Lean protein + moderate carbs"},
        {key:"snack2",time:"16:00",title:"Snack",note:"Protein + veggies"},
        {key:"dinner",time:"19:00",title:"Dinner",note:"Protein + greens + olive oil"},
        {key:"cutoff",time:"21:45",title:"Food Cutoff",note:"No food after this time"},
        {key:"dose",time:"22:30",title:"Sermorelin 40 mg",note:""}
      ]},
      3:{type:"Upper Strength + Cardio",workoutType:"strength",dose:true,schedule:[
        {key:"hydrate",time:"06:15",title:"Wake & Hydrate",note:"16‚Äì20 oz water"},
        {key:"workout",time:"06:30",title:"Upper + 20m Cardio",note:"45 min upper + 20 min steady",details:"Pull‚ÄëUps ‚Üí alt: Lat Pulldown; Incline DB Press ‚Üí alt: Barbell Incline; Barbell Row ‚Üí alt: Single‚ÄëArm Row; DB Laterals ‚Üí alt: Cable Laterals; Dips ‚Üí alt: Rope Pushdown; Curls ‚Üí alt: Hammer Curl"},
        {key:"postwo",time:"07:45",title:"Post‚ÄëWorkout",note:"Protein + moderate carbs"},
        {key:"snack1",time:"10:30",title:"Snack",note:"Protein + fats"},
        {key:"lunch",time:"13:00",title:"Lunch",note:"Lean protein + moderate carbs"},
        {key:"snack2",time:"16:30",title:"Snack",note:"Protein + veggies"},
        {key:"dinner",time:"19:00",title:"Dinner",note:"Protein + low‚Äëcarb veggies + fats"},
        {key:"cutoff",time:"21:45",title:"Food Cutoff",note:"No food after this time"},
        {key:"dose",time:"22:30",title:"Sermorelin 40 mg",note:""}
      ]},
      4:{type:"HIIT",workoutType:"hiit",dose:true,schedule:[
        {key:"hydrate",time:"06:15",title:"Wake & Hydrate",note:"16‚Äì20 oz water"},
        {key:"workout",time:"06:30",title:"HIIT Training",note:"15 min high intensity",details:"Battle ropes 30s on / 30s off √ó 10 or Sprints 15s all‚Äëout / 45s walk √ó 10"},
        {key:"postwo",time:"06:50",title:"Post‚ÄëWorkout",note:"Protein + small carbs"},
        {key:"snack1",time:"10:00",title:"Snack",note:"Protein + fats"},
        {key:"lunch",time:"13:00",title:"Lunch",note:"Lean protein + moderate carbs"},
        {key:"snack2",time:"16:00",title:"Snack",note:"Protein + veggies"},
        {key:"dinner",time:"19:00",title:"Dinner",note:"Protein + greens + olive oil"},
        {key:"cutoff",time:"21:45",title:"Food Cutoff",note:"No food after this time"},
        {key:"dose",time:"22:30",title:"Sermorelin 40 mg",note:""}
      ]},
      5:{type:"Lower Strength + Cardio",workoutType:"strength",dose:true,schedule:[
        {key:"hydrate",time:"06:15",title:"Wake & Hydrate",note:"16‚Äì20 oz water"},
        {key:"workout",time:"06:30",title:"Lower + 20‚Äì30m Cardio",note:"45 min lower + 20‚Äì30 min steady",details:"Deadlift ‚Üí alt: Trap Bar; Walking Lunges ‚Üí alt: Step‚ÄëUps; Hip Thrust ‚Üí alt: Glute Bridge; Bulgarian Split Squat ‚Üí alt: Goblet Squat; Standing Calf Raise ‚Üí alt: Seated Calf Raise"},
        {key:"postwo",time:"07:45",title:"Post‚ÄëWorkout",note:"Protein + moderate carbs"},
        {key:"snack1",time:"10:30",title:"Snack",note:"Protein + fats"},
        {key:"lunch",time:"13:00",title:"Lunch",note:"Lean protein + moderate carbs"},
        {key:"snack2",time:"16:30",title:"Snack",note:"Protein + veggies"},
        {key:"dinner",time:"19:00",title:"Dinner",note:"Protein + low‚Äëcarb veggies + fats"},
        {key:"cutoff",time:"21:45",title:"Food Cutoff",note:"No food after this time"},
        {key:"dose",time:"22:30",title:"Sermorelin 40 mg",note:""}
      ]},
      6:{type:"Active Recovery",workoutType:"recovery",dose:false,schedule:[
        {key:"hydrate",time:"07:00",title:"Wake & Hydrate",note:"16‚Äì20 oz water"},
        {key:"activity",time:"07:30",title:"Fasted Walk / Yoga",note:"20‚Äì30 min light activity"},
        {key:"breakfast",time:"09:00",title:"Breakfast",note:"Protein + fats (low carb)"},
        {key:"lunch",time:"12:30",title:"Lunch",note:"Protein + greens (low carb)"},
        {key:"dinner",time:"18:00",title:"Dinner",note:"Protein + veggies (low carb)"},
        {key:"sleep",time:"22:00",title:"Wind Down",note:"No food 2 hrs before bed"}
      ]}
    };
    
    const ICONS={strength:"üèãÔ∏è",hiit:"‚ö°",recovery:"üö∂",rest:"üò¥"}; 
    const DAY_NAMES=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
    let currentEditingTime = null;
    let currentEditingExerciseId = null;
    let lastTrackedDate = null; // Track date changes

    // ---- State helpers ----
    function loadState(){ 
      try{
        const state = JSON.parse(localStorage.getItem("mfl_state_v24")||"{}");
        // Migrate from old version if needed
        if (localStorage.getItem("mfl_state_v23b") && !localStorage.getItem("mfl_state_v24")) {
          try {
            const oldState = JSON.parse(localStorage.getItem("mfl_state_v23b"));
            localStorage.setItem("mfl_state_v24", JSON.stringify(oldState));
            console.log("Migrated from v23b to v24");
            return oldState;
          } catch(e) {
            console.log("Migration failed, starting fresh");
          }
        }
        return state;
      }catch(e){return {}}
    }
    function saveState(s){ localStorage.setItem("mfl_state_v24", JSON.stringify(s)) }
    function todayKey(){ return new Date().toISOString().slice(0,10) }
    function getDow(){ return Number(document.querySelector('.chip[aria-pressed="true"]')?.dataset.day ?? new Date().getDay()) }
    
    function toHuman(hm){ 
      if(!hm||hm.includes(':')===false) return hm; 
      const [h,m]=hm.split(':').map(Number); 
      const d=new Date(); d.setHours(h); d.setMinutes(m); 
      return d.toLocaleTimeString([], {hour:'numeric',minute:'2-digit'}) 
    }

    // ---- Day Change Detection ----
    function checkForDayChange() {
      const currentDate = todayKey();
      
      if (lastTrackedDate && lastTrackedDate !== currentDate) {
        console.log('Day change detected:', lastTrackedDate, '->', currentDate);
        showDayChangeNotification();
        
        // Reset daily completion tracking
        const s = loadState();
        s._markedToday = false;
        saveState(s);
        
        // Update all UI elements
        renderAll();
      }
      
      lastTrackedDate = currentDate;
    }

    function showDayChangeNotification() {
      const indicator = document.getElementById('dayChangeIndicator');
      indicator.classList.add('show');
      
      setTimeout(() => {
        indicator.classList.remove('show');
      }, 3000);
    }

    function initDefaults(){
      const s=loadState();
      if(!s.waterGoal) s.waterGoal=8;
      if(!s.proteinGoal) s.proteinGoal=120;
      if(!s.water) s.water={};
      if(!s.checks) s.checks={}; // dateKey -> { itemKey: true }
      if(!s.streak) s.streak=0;
      if(!s.weekStart){
        const t=new Date(); const mon=new Date(t); const dow=mon.getDay(); const diff=(dow===0?-6:1)-dow; mon.setDate(t.getDate()+diff); s.weekStart=mon.toISOString().slice(0,10);
      }
      if(!s.logs) s.logs={};
      if(!s.prs) s.prs={};
      if(!s.exercises) s.exercises={};
      if(!s.customTimes) s.customTimes={};
      if(!s.workouts) s.workouts={}; // For storing workout data by date
      saveState(s);
      
      // Initialize day change tracking
      lastTrackedDate = todayKey();
    }

    // ---- Protein Ring Functions ----
    function updateProteinRing() {
      const s = loadState();
      const dk = todayKey(); // Always use current day
      const current = s.logs[dk]?.protein || 0; // Default to 0 for new day
      const goal = s.proteinGoal || 120;
      const percentage = Math.min((current / goal) * 100, 100);
      
      document.getElementById('proteinCurrent').textContent = current + 'g';
      document.getElementById('proteinGoalText').textContent = `Goal: ${goal}g (${Math.round(percentage)}%)`;
      
      const ring = document.getElementById('proteinProgressRing');
      const circumference = 2 * Math.PI * 40;
      const strokeDasharray = `${(percentage / 100) * circumference} ${circumference}`;
      ring.style.strokeDasharray = strokeDasharray;
    }

    function updateProteinGoal() {
      const goal = parseInt(document.getElementById('proteinGoalInput').value);
      if (goal && goal >= 50 && goal <= 300) {
        const s = loadState();
        s.proteinGoal = goal;
        saveState(s);
        updateProteinRing();
        document.getElementById('proteinGoalInput').value = '';
        triggerSuccessFeedback(`Protein goal set to ${goal}g! üéØ`);
      }
    }

    function addQuickProtein(amount) {
      const s = loadState();
      const dk = todayKey(); // Always use current day
      if (!s.logs[dk]) s.logs[dk] = {};
      const current = s.logs[dk].protein || 0; // Default to 0 for new day
      s.logs[dk].protein = current + amount;
      saveState(s);
      updateProteinRing();
      
      // Update log input if on log page
      const proteinInput = document.getElementById('logProtein');
      if (proteinInput && proteinInput.closest('.view').classList.contains('active')) {
        proteinInput.value = s.logs[dk].protein;
      }
    }

    // ---- Water Functions ----
    function addQuickWater(glasses) {
      const s = loadState();
      const dk = todayKey(); // Always use current day
      const current = s.water[dk] || 0; // Default to 0 for new day
      const newAmount = Math.max(0, Math.min(current + glasses, s.waterGoal));
      s.water[dk] = newAmount;
      saveState(s);
      renderWater();
      updateProgress();
    }

    function renderWater(){
      const s=loadState(); 
      const dk=todayKey(); // Always use current day
      const cur=s.water[dk]||0; // Default to 0 for new day
      document.getElementById('waterCurrent').textContent=cur;
      
      const wrap=document.getElementById('waterDrops'); wrap.innerHTML='';
      for(let i=0;i<s.waterGoal;i++){ 
        const b=document.createElement('button'); 
        b.type='button'; 
        b.className='drop'+(i<cur?' filled':''); 
        b.addEventListener('click',()=>{ 
          const st=loadState(); 
          const c=st.water[dk]||0; 
          st.water[dk]=(i<c)?i:i+1; 
          saveState(st); 
          renderWater(); 
          updateProgress(); 
        }); 
        wrap.append(b); 
      }
      document.getElementById('waterProgress').style.width = ((cur/s.waterGoal)*100).toFixed(0)+'%';
    }

    // ---- Time Editing Functions ----
    function editTime(dow, itemKey, currentTime) {
      currentEditingTime = { dow, itemKey, currentTime };
      document.getElementById('timeInput').value = currentTime;
      document.getElementById('timeEditDialog').showModal();
    }

    function closeTimeDialog() {
      document.getElementById('timeEditDialog').close();
      currentEditingTime = null;
    }

    function saveTimeEdit() {
      if (!currentEditingTime) return;
      
      const newTime = document.getElementById('timeInput').value;
      const { dow, itemKey } = currentEditingTime;
      
      const s = loadState();
      if (!s.customTimes) s.customTimes = {};
      if (!s.customTimes[dow]) s.customTimes[dow] = {};
      s.customTimes[dow][itemKey] = newTime;
      saveState(s);
      
      renderTimeline();
      closeTimeDialog();
    }

    // ---- Enhanced Feedback System ----
    function triggerSuccessFeedback(message) {
      // Visual feedback
      const feedback = document.createElement('div');
      feedback.innerHTML = message;
      feedback.style.position = 'fixed';
      feedback.style.top = '20px';
      feedback.style.right = '20px';
      feedback.style.background = 'var(--gradient-primary)';
      feedback.style.color = 'white';
      feedback.style.padding = '12px 16px';
      feedback.style.borderRadius = '8px';
      feedback.style.zIndex = '1000';
      feedback.style.fontWeight = '600';
      feedback.style.boxShadow = '0 4px 16px rgba(90, 127, 113, 0.4)';
      feedback.className = 'success-feedback';
      
      document.body.appendChild(feedback);
      
      setTimeout(() => {
        feedback.style.opacity = '0';
        feedback.style.transform = 'translateX(100px)';
        feedback.style.transition = 'all 0.3s ease';
        setTimeout(() => feedback.remove(), 300);
      }, 2000);
      
      // Haptic feedback for mobile
      if (navigator.vibrate) {
        navigator.vibrate([50, 30, 50]);
      }
    }
    
    function addSuccessAnimation(element) {
      element.classList.add('success-feedback');
      setTimeout(() => {
        element.classList.remove('success-feedback');
      }, 300);
    }

    // ---- Rendering Today ----
    function renderHeader(){
      const dow=getDow(); const meta=WEEKLY_SCHEDULE[dow];
      document.getElementById('dayName').textContent=DAY_NAMES[dow];
      document.getElementById('dayType').textContent = `${ICONS[meta.workoutType]} ${meta.type} ‚Ä¢ ${meta.dose ? 'Dose day' : 'No dose'}`;
      const s=loadState(); document.getElementById('streakCount').textContent = s.streak||0;
      const start=new Date(s.weekStart); const diffDays = Math.floor((Date.now()-start.getTime())/86400000);
      const weekNum = Math.floor(diffDays/7)+1; document.getElementById('weekLabel').textContent = `Week ${Math.max(1, weekNum)}`;
    }

    function getTimeForItem(dow, itemKey, defaultTime) {
      const s = loadState();
      return s.customTimes?.[dow]?.[itemKey] || defaultTime;
    }

    function renderTimeline(){
      const timeline=document.getElementById('timeline'); timeline.innerHTML='';
      const s=loadState(); const dk=todayKey(); const checks=s.checks[dk]||{}; const dow=getDow(); const plan=WEEKLY_SCHEDULE[dow].schedule;
      
      plan.forEach(item=>{
        const li=document.createElement('li'); const div=document.createElement('div'); div.className='task';
        const id=`${dow}-${item.key}`; const cb=document.createElement('input'); cb.type='checkbox'; cb.id=id; cb.checked=!!checks[id];
        cb.addEventListener('change',()=>{ const st=loadState(); st.checks[dk]=st.checks[dk]||{}; st.checks[dk][id]=cb.checked; saveState(st); updateProgress(); renderWeek(); });
        
        const currentTime = getTimeForItem(dow, item.key, item.time);
        const lbl=document.createElement('label'); lbl.setAttribute('for', id);
        lbl.innerHTML = `<div class="task-time" onclick="editTime(${dow}, '${item.key}', '${currentTime}')">${toHuman(currentTime)}</div><div class="task-title">${item.title}</div><div class="task-note">${item.note||''}</div>`;
        div.append(cb,lbl); li.append(div); timeline.append(li);
      });
    }

    function renderWeek(){
      const s=loadState(); const weekOverview=document.getElementById('weekOverview'); weekOverview.innerHTML=''; const weekSchedule=document.getElementById('weekSchedule'); weekSchedule.innerHTML='';
      const start=new Date(s.weekStart); let doneDays=0;
      for(let i=0;i<7;i++){
        const d=new Date(start); d.setDate(start.getDate()+i); const dateKey=d.toISOString().slice(0,10); const dow=d.getDay();
        const plan=WEEKLY_SCHEDULE[dow]; const checks=s.checks[dateKey]||{}; const completed=Object.values(checks).filter(Boolean).length; const total=plan.schedule.length; const water=(s.water[dateKey]||0)/(s.waterGoal||8);
        const pct = Math.min(1, (total?completed/total:0)*0.8 + water*0.2);
        const row=document.createElement('li'); row.className='card'; if(new Date().toDateString()===d.toDateString()){ row.classList.add('today-highlight'); }
        row.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><div><strong>${DAY_NAMES[dow]}</strong> ‚Ä¢ ${ICONS[plan.workoutType]} ${plan.type} ‚Ä¢ ${plan.dose?'Dose':'No dose'}</div><div style="min-width:46px;text-align:right"><strong>${Math.round(pct*100)}%</strong></div></div><div class="progress-bar"><div class="progress-fill" style="width:${(pct*100).toFixed(0)}%"></div></div>`;
        weekOverview.append(row);
        
        const sched=document.createElement('div'); sched.className='card'; if(new Date().toDateString()===d.toDateString()){ sched.classList.add('today-highlight'); }
        sched.innerHTML=`<h3 style="margin:0 0 6px">${DAY_NAMES[dow]} ‚Äì ${plan.type}</h3>`;
        plan.schedule.forEach(item=>{ const line=document.createElement('div'); line.className='muted'; line.style.margin='2px 0'; line.textContent = `${toHuman(getTimeForItem(dow, item.key, item.time))} ‚Ä¢ ${item.title}`; sched.append(line); });
        weekSchedule.append(sched);
        if(pct>=0.9) doneDays++;
      }
      const pctWeek = Math.round((doneDays/7)*100); document.getElementById('weekCompleted').textContent=doneDays; document.getElementById('weekPercentage').textContent=pctWeek+'%';
    }

    function updateProgress(){
      const s=loadState(); const dk=todayKey(); const dow=getDow(); const plan=WEEKLY_SCHEDULE[dow];
      const checks=s.checks[dk]||{}; const completed=Object.values(checks).filter(Boolean).length; const total=plan.schedule.length; const water=(s.water[dk]||0)/(s.waterGoal||8);
      const pct=Math.min(1, (total?completed/total:0)*0.8 + water*0.2);
      if(pct>=0.9 && !s._markedToday){ s._markedToday=true; s.streak=(s.streak||0)+1; saveState(s); document.getElementById('streakCount').textContent=s.streak; }
    }

    // ---- Enhanced Workout Section with Different Metrics ----
    function renderWorkoutSection() {
      const dow = getDow();
      const container = document.getElementById('workoutSection');
      const workoutTypeSpan = document.getElementById('workoutType');
      
      if (!container) return;
      
      container.innerHTML = '';
      const exercises = WORKOUT_EXERCISES[dow] || [];
      const schedule = WEEKLY_SCHEDULE[dow];
      
      // Update workout type indicator
      if (workoutTypeSpan) {
        workoutTypeSpan.textContent = schedule.type;
      }
      
      if (exercises.length === 0) {
        container.innerHTML = '<div class="muted" style="text-align:center; padding:20px;">No workout for this day</div>';
        return;
      }
      
      // Load existing workout data
      const s = loadState();
      const dk = todayKey();
      if (!s.workouts) s.workouts = {};
      const workoutData = s.workouts[dk] || {};
      
      exercises.forEach((exercise, index) => {
        const row = document.createElement('div');
        row.className = `workout-row ${exercise.type}`;
        row.id = `workout-row-${index}`;
        
        const currentExercise = workoutData[`ex_${index}`] || '';
        const currentValue = workoutData[`val_${index}`] || '';
        
        // Mark as completed if both exercise and value are filled
        if (currentExercise && currentValue) {
          row.classList.add('completed');
        }
        
        // Create dropdown options
        const optionsHTML = exercise.options.map(option => 
          `<option value="${option}" ${option === currentExercise ? 'selected' : ''}>${option}</option>`
        ).join('');
        
        // Different input types based on exercise type
        let inputHTML = '';
        let unit = '';
        
        switch (exercise.type) {
          case 'strength':
            inputHTML = `<input type="number" class="metric-input" id="metric-${index}" placeholder="lbs" step="0.5" min="0" value="${currentValue}" />`;
            unit = 'lbs';
            break;
          case 'hiit':
          case 'cardio':
            inputHTML = `<input type="number" class="metric-input" id="metric-${index}" placeholder="min" step="0.5" min="0" value="${currentValue}" />`;
            unit = 'min';
            break;
          case 'core':
            inputHTML = `<input type="number" class="metric-input" id="metric-${index}" placeholder="reps" step="1" min="0" value="${currentValue}" />`;
            unit = 'reps';
            break;
          case 'recovery':
          case 'rest':
            inputHTML = `<input type="checkbox" id="metric-${index}" ${currentValue === 'true' ? 'checked' : ''} style="width:20px; height:20px;" />`;
            unit = '';
            break;
        }
        
        row.innerHTML = `
          <select class="exercise-select" id="exercise-${index}">
            <option value="">${exercise.category}</option>
            ${optionsHTML}
          </select>
          ${inputHTML}
          ${exercise.type !== 'recovery' && exercise.type !== 'rest' ? `
          <div class="save-indicator" id="save-${index}">
            <span id="save-text-${index}">Saved ‚úì</span>
            <span id="pr-badge-${index}"></span>
          </div>
          ` : ''}
        `;
        
        container.appendChild(row);
        
        // Add event listeners
        const exerciseSelect = document.getElementById(`exercise-${index}`);
        const metricInput = document.getElementById(`metric-${index}`);
        
        if (exerciseSelect && metricInput) {
          exerciseSelect.addEventListener('change', () => saveWorkoutData(index, exercise.type));
          
          if (exercise.type === 'recovery' || exercise.type === 'rest') {
            metricInput.addEventListener('change', () => saveWorkoutData(index, exercise.type));
          } else {
            metricInput.addEventListener('input', () => saveWorkoutData(index, exercise.type));
          }
        }
      });
    }

    function saveWorkoutData(index, exerciseType) {
      const exerciseSelect = document.getElementById(`exercise-${index}`);
      const metricInput = document.getElementById(`metric-${index}`);
      const row = document.getElementById(`workout-row-${index}`);
      
      if (!exerciseSelect || !metricInput) return;
      
      const exercise = exerciseSelect.value;
      let value;
      
      // Get value based on exercise type
      if (exerciseType === 'recovery' || exerciseType === 'rest') {
        value = metricInput.checked ? 'true' : 'false';
      } else {
        value = parseFloat(metricInput.value) || 0;
      }
      
      const s = loadState();
      const dk = todayKey();
      
      if (!s.workouts) s.workouts = {};
      if (!s.workouts[dk]) s.workouts[dk] = {};
      
      // Save data
      s.workouts[dk][`ex_${index}`] = exercise;
      s.workouts[dk][`val_${index}`] = value;
      
      // Check for PR only for strength exercises
      if (exercise && value > 0 && exerciseType === 'strength') {
        const exerciseKey = exercise.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
        if (!s.prs) s.prs = {};
        
        let isPR = false;
        if (!s.prs[exerciseKey] || value > (s.prs[exerciseKey].maxWeight || 0)) {
          s.prs[exerciseKey] = {
            name: exercise,
            maxWeight: value,
            date: dk
          };
          isPR = true;
        }
        
        // Show PR feedback
        if (isPR) {
          const prBadge = document.getElementById(`pr-badge-${index}`);
          if (prBadge) {
            prBadge.innerHTML = '<span class="pr-indicator">PR!</span>';
            setTimeout(() => {
              prBadge.innerHTML = '';
            }, 5000);
          }
          triggerSuccessFeedback(`New PR! ${exercise}: ${value} lbs üèÜ`);
        }
      }
      
      // Update visual state
      if (row) {
        const isCompleted = exercise && ((exerciseType === 'recovery' || exerciseType === 'rest') ? value === 'true' : value > 0);
        if (isCompleted) {
          row.classList.add('completed');
        } else {
          row.classList.remove('completed');
        }
      }
      
      // Show saved indicator (not for recovery/rest)
      if (exerciseType !== 'recovery' && exerciseType !== 'rest') {
        const saveIndicator = document.getElementById(`save-${index}`);
        if (saveIndicator && exercise && value > 0) {
          saveIndicator.classList.add('show');
          setTimeout(() => {
            saveIndicator.classList.remove('show');
          }, 2000);
        }
      }
      
      saveState(s);
    }

    // ---- Log tab ----
    function pad(n){ return String(n).padStart(2,'0') }
    function todayISO(){ const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}` }

    function loadLog(dateKey){
      const s=loadState(); const L=s.logs[dateKey]||{};
      const set=(id,v)=>{ const el=document.getElementById(id); if(el) el.value = (v ?? ''); };
      set('logDate', dateKey);
      set('logWeight', L.weight); set('logWaist', L.waist); set('logHips', L.hips); set('logChest', L.chest); set('logThigh', L.thigh); set('logArm', L.arm);
      set('logProtein', L.protein); set('logSleep', L.sleep); set('logSteps', L.steps); set('logMood', L.mood);
      
      // Load exercises for this date
      const exerciseLog = document.getElementById('exerciseLog');
      exerciseLog.innerHTML = '';
      if (L.exercises) {
        Object.entries(L.exercises).forEach(([exerciseId, exercise]) => {
          renderExerciseEntry(exerciseId, exercise.name, exercise.sets);
        });
      }
      
      updateProteinRing();
    }

    function saveLog(){
      const dateKey=document.getElementById('logDate').value || todayISO();
      const get=(id)=>{ const v=document.getElementById(id).value; return v===''?undefined:(isNaN(v)?v:parseFloat(v)); };
      
      const exercises = getExerciseData();
      const prs = calculatePRs(exercises);
      
      const L={ weight:get('logWeight'), waist:get('logWaist'), hips:get('logHips'), chest:get('logChest'), thigh:get('logThigh'), arm:get('logArm'),
                protein:get('logProtein'), sleep:get('logSleep'), steps:get('logSteps'), mood:get('logMood'), exercises: exercises };
      
      const s=loadState(); 
      s.logs[dateKey]=Object.assign({}, s.logs[dateKey]||{}, L); 
      
      // Update PRs
      if (!s.prs) s.prs = {};
      Object.entries(prs).forEach(([key, pr]) => {
        if (!s.prs[key] || pr.maxWeight > (s.prs[key].maxWeight || 0)) {
          s.prs[key] = pr;
        }
      });
      
      saveState(s); 
      updateProteinRing();
      triggerSuccessFeedback('Log saved successfully! üìä'); 
      renderProgress();
    }

    function initLog(){
      const d=todayISO(); document.getElementById('logDate').value=d; loadLog(d);
      document.getElementById('logDate').addEventListener('change', e=>loadLog(e.target.value));
      document.getElementById('saveLogBtn').addEventListener('click', saveLog);
      document.getElementById('addExerciseBtn').addEventListener('click', addExercise);
      
      document.getElementById('exportBtn').addEventListener('click', ()=>{
        const data = loadState();
        const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
        const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='morning-fat-loss-backup.json'; a.click();
        setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
      });
      document.getElementById('importInput').addEventListener('change', (e)=>{
        const file=e.target.files[0]; if(!file) return;
        const reader=new FileReader(); reader.onload=()=>{ try{ localStorage.setItem('mfl_state_v24', reader.result); alert('Imported ‚úî'); renderAll(); renderWeek(); renderProgress(); }catch(err){ alert('Import failed'); } }; reader.readAsText(file);
      });
    }

    // ---- Exercise Management Functions ----
    function addExercise() {
      document.getElementById('exerciseDialog').showModal();
    }

    function closeExerciseDialog() {
      document.getElementById('exerciseDialog').close();
    }

    function saveNewExercise() {
      const exerciseName = document.getElementById('exerciseNameInput').value.trim();
      if (!exerciseName) return;
      
      const exerciseId = Date.now().toString();
      renderExerciseEntry(exerciseId, exerciseName, []);
      document.getElementById('exerciseNameInput').value = '';
      closeExerciseDialog();
    }

    function renderExerciseEntry(exerciseId, exerciseName, maxWeight = '') {
      const container = document.getElementById('exerciseLog');
      const entry = document.createElement('div');
      entry.className = 'exercise-entry-simple';
      entry.id = `exercise-${exerciseId}`;
      
      entry.innerHTML = `
        <input type="text" class="exercise-weight-input" value="${exerciseName}" placeholder="Exercise name" onchange="updateExerciseName('${exerciseId}', this.value)">
        <input type="number" class="exercise-weight-input" value="${maxWeight}" placeholder="Max weight" step="0.5" onchange="updateExerciseWeight('${exerciseId}', this.value)">
        <button class="btn small" onclick="removeExercise('${exerciseId}')" style="background:var(--warning); color:white">√ó</button>
      `;
      
      container.appendChild(entry);
    }

    function updateExerciseName(exerciseId, name) {
      // Update will be handled when saving
    }

    function updateExerciseWeight(exerciseId, weight) {
      // Update will be handled when saving
    }

    function removeExercise(exerciseId) {
      document.getElementById(`exercise-${exerciseId}`).remove();
    }

    function getExerciseData() {
      const exercises = {};
      const exerciseEntries = document.querySelectorAll('.exercise-entry-simple');
      
      exerciseEntries.forEach((entry, index) => {
        const exerciseId = entry.id.replace('exercise-', '') || `exercise_${index}`;
        const inputs = entry.querySelectorAll('.exercise-weight-input');
        const exerciseName = inputs[0].value.trim();
        const maxWeight = parseFloat(inputs[1].value) || 0;
        
        if (exerciseName && maxWeight > 0) {
          exercises[exerciseId] = {
            name: exerciseName,
            maxWeight: maxWeight
          };
        }
      });
      
      return exercises;
    }

    function calculatePRs(exercises) {
      const prs = {};
      
      Object.entries(exercises).forEach(([key, exercise]) => {
        const { name, maxWeight } = exercise;
        const exerciseKey = name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
        
        prs[exerciseKey] = {
          name: name,
          maxWeight: maxWeight,
          date: todayKey()
        };
      });
      
      return prs;
    }

    // ---- Weekly Metrics Functions ----
    function saveWeeklyMetrics() {
      const weight = parseFloat(document.getElementById('weeklyWeight').value);
      const waist = parseFloat(document.getElementById('weeklyWaist').value);
      const hips = parseFloat(document.getElementById('weeklyHips').value);
      
      if (!weight && !waist && !hips) {
        alert('Please enter at least one measurement');
        return;
      }
      
      const s = loadState();
      const dk = todayKey();
      
      if (!s.logs[dk]) s.logs[dk] = {};
      if (weight) s.logs[dk].weight = weight;
      if (waist) s.logs[dk].waist = waist;
      if (hips) s.logs[dk].hips = hips;
      
      saveState(s);
      
      // Clear inputs
      document.getElementById('weeklyWeight').value = '';
      document.getElementById('weeklyWaist').value = '';
      document.getElementById('weeklyHips').value = '';
      
      triggerSuccessFeedback('Weekly metrics saved! üìè‚ú®');
      renderProgress();
    }

    // ---- Progress tab ----
    function drawLineChart(canvasId, points, color){
      const cv=document.getElementById(canvasId); if(!cv) return; const ctx=cv.getContext('2d'); const w=cv.width, h=cv.height;
      ctx.clearRect(0,0,w,h);
      ctx.strokeStyle='rgba(0,0,0,0.1)'; ctx.lineWidth=1;
      ctx.beginPath(); ctx.moveTo(32,8); ctx.lineTo(32,h-24); ctx.lineTo(w-8,h-24); ctx.stroke();
      if(points.length<2) return;
      const xs=points.map(p=>p.x), ys=points.map(p=>p.y);
      const minX=Math.min(...xs), maxX=Math.max(...xs), minY=Math.min(...ys), maxY=Math.max(...ys);
      const px=x=>32 + ( (x-minX) / Math.max(1,(maxX-minX)) ) * (w-40);
      const py=y=> (h-24) - ( (y-minY) / Math.max(1,(maxY-minY)) ) * (h-40);
      ctx.strokeStyle=color||'#5a7f71'; ctx.lineWidth=2; ctx.beginPath();
      points.forEach((p,i)=>{ const X=px(p.x), Y=py(p.y); if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y); }); ctx.stroke();
      ctx.fillStyle=color||'#5a7f71'; points.forEach(p=>{ const X=px(p.x), Y=py(p.y); ctx.beginPath(); ctx.arc(X,Y,3,0,Math.PI*2); ctx.fill(); });
    }

    function daysSinceEpoch(iso){ return Math.floor(new Date(iso).getTime()/86400000); }
    function calcChange(arr){ if(arr.length<2) return '‚Äî'; const first=arr[0].y, last=arr[arr.length-1].y; const diff = last-first; const sign = diff>0?'+':''; return `${sign}${diff.toFixed(1)}`; }
    function getLogsSorted(){ const s=loadState(); const entries=Object.entries(s.logs||{}).sort((a,b)=>new Date(a[0])-new Date(b[0])); return entries; }

    function renderPRs() {
      const s = loadState();
      const prGrid = document.getElementById('prGrid');
      prGrid.innerHTML = '';
      
      if (!s.prs || Object.keys(s.prs).length === 0) {
        prGrid.innerHTML = '<div class="muted" style="grid-column: 1/-1; text-align: center; padding: 20px;">No personal records yet. Start logging workouts!</div>';
        return;
      }
      
      Object.entries(s.prs).forEach(([key, pr]) => {
        const card = document.createElement('div');
        card.className = 'pr-card';
        card.innerHTML = `
          <div class="pr-lift">${pr.name}</div>
          <div class="pr-value">${pr.maxWeight} lb</div>
          <div class="pr-date">${new Date(pr.date).toLocaleDateString()}</div>
        `;
        prGrid.appendChild(card);
      });
    }

    function renderProgress(){
      const entries=getLogsSorted();
      const wPts = entries.filter(([d,L])=>L.weight!=null).map(([d,L])=>({x:daysSinceEpoch(d), y:Number(L.weight)}));
      drawLineChart('chartWeight', wPts, getComputedStyle(document.documentElement).getPropertyValue('--accent').trim());
      document.getElementById('weightChange').textContent = wPts.length?`Œî ${calcChange(wPts)} lb`:'‚Äî';
      const waistPts = entries.filter(([d,L])=>L.waist!=null).map(([d,L])=>({x:daysSinceEpoch(d), y:Number(L.waist)}));
      drawLineChart('chartWaist', waistPts, getComputedStyle(document.documentElement).getPropertyValue('--drop').trim());
      document.getElementById('waistChange').textContent = waistPts.length?`Œî ${calcChange(waistPts)} in`:'‚Äî';

      // Enhanced weekly averages calculation
      const s=loadState(); const start=new Date(s.weekStart); const end=new Date(start); end.setDate(start.getDate()+7);
      let workouts=0, proteinSum=0, proteinDays=0, sleepSum=0, sleepDays=0, waterSum=0, waterDays=0;
      
      for(let i=0;i<7;i++){
        const d=new Date(start); d.setDate(start.getDate()+i); const dk=d.toISOString().slice(0,10);
        const checks=s.checks[dk]||{}; const total=(Object.keys(checks).length||1); const done=(Object.values(checks).filter(Boolean).length)/(total);
        if(done>=0.6) workouts++;
        
        // Protein averages from logs
        const L=s.logs[dk]; 
        if(L && L.protein != null){ 
          proteinSum += Number(L.protein); 
          proteinDays++; 
        }
        if(L && L.sleep != null){ 
          sleepSum += Number(L.sleep); 
          sleepDays++; 
        }
        
        // Water averages from daily tracking
        if(s.water[dk] != null){ 
          waterSum += Number(s.water[dk]); 
          waterDays++; 
        }
      }
      
      document.getElementById('sumWorkouts').textContent = `${workouts}/7`;
      document.getElementById('sumProtein').textContent = proteinDays ? `${Math.round(proteinSum/proteinDays)} g` : '‚Äî';
      document.getElementById('sumSleep').textContent = sleepDays ? (sleepSum/sleepDays).toFixed(1)+' h' : '‚Äî';
      document.getElementById('sumWater').textContent = waterDays ? (waterSum/waterDays).toFixed(1)+' cups' : '‚Äî';

      renderPRs();
    }

    // ---- Navigation ----
    document.querySelectorAll('.tabbar button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tabbar button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
        document.getElementById(btn.dataset.target).classList.add('active');
        window.scrollTo({top:0, behavior:'smooth'});
        if(btn.dataset.target==='view-week'){ renderWeek(); }
        if(btn.dataset.target==='view-progress'){ renderProgress(); }
        if(btn.dataset.target==='view-log'){ initLog(); }
      });
    });

    // Weekly metrics save button
    document.getElementById('saveWeeklyMetrics').addEventListener('click', saveWeeklyMetrics);

    // Weekday picker
    document.querySelectorAll('.chip').forEach(chip=>{
      chip.addEventListener('click', ()=>{
        document.querySelectorAll('.chip').forEach(c=>c.setAttribute('aria-pressed','false'));
        chip.setAttribute('aria-pressed','true'); 
        renderAll();
      });
    });

    function setPickerToToday(){
      const dow=new Date().getDay(); const chip=document.querySelector(`.chip[data-day="${dow}"]`);
      if(chip){ chip.setAttribute('aria-pressed','true'); chip.classList.add('today-chip'); }
    }

    function renderAll(){ 
      checkForDayChange(); // Check for day changes first
      renderHeader(); 
      renderTimeline(); 
      renderWater(); 
      updateProteinRing();
      renderWorkoutSection();
      updateProgress(); 
    }

    // ---- Dialog Event Listeners ----
    document.getElementById('timeEditDialog').addEventListener('close', (e) => {
      if (e.target.returnValue === 'default') {
        saveTimeEdit();
      }
    });

    document.getElementById('exerciseDialog').addEventListener('close', (e) => {
      if (e.target.returnValue === 'default') {
        saveNewExercise();
      }
    });

    // Initialize premium visual features
    function initPremiumFeatures() {
      // Enhanced task completion feedback
      document.addEventListener('change', (e) => {
        if (e.target.type === 'checkbox' && e.target.closest('.task')) {
          if (e.target.checked) {
            triggerSuccessFeedback('Task completed! ‚úÖ');
            addSuccessAnimation(e.target.closest('.task'));
          }
        }
      });
      
      // Protein goal achievement celebration
      const originalUpdateProteinRing = updateProteinRing;
      window.updateProteinRing = function() {
        const s = loadState();
        const dk = todayKey();
        const current = s.logs[dk]?.protein || 0;
        const goal = s.proteinGoal || 120;
        const wasAtGoal = document.getElementById('proteinCurrent').textContent.replace('g', '') >= goal;
        
        originalUpdateProteinRing();
        
        // Celebrate reaching protein goal
        if (current >= goal && !wasAtGoal) {
          setTimeout(() => {
            triggerSuccessFeedback('Protein goal achieved! üéâ');
            const ringElement = document.querySelector('.protein-ring');
            addSuccessAnimation(ringElement);
          }, 300);
        }
      };
    }

    // Initialize protein goal input
    function initProteinGoal() {
      const s = loadState();
      document.getElementById('proteinGoalInput').placeholder = s.proteinGoal || 120;
    }

    // ---- App Lifecycle Functions ----
    
    // Check for day changes periodically
    function startDayChangeMonitoring() {
      // Check every minute
      setInterval(checkForDayChange, 60000);
      
      // Also check when app becomes visible again
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
          checkForDayChange();
        }
      });
    }

    // Init
    initDefaults(); 
    setPickerToToday(); 
    initProteinGoal();
    initPremiumFeatures();
    startDayChangeMonitoring();
    renderAll(); 
    renderWeek(); 
    renderProgress();
    
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('./service-worker.js').catch(()=>{}); }
  </script>
</body>
</html>
