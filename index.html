<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>4-Week Fat Loss Tracker</title>
  <meta name="description" content="A calm, nature‚Äëthemed habit tracker for workouts, dosing, water, and nutrition." />
  <meta name="theme-color" content="#5a7f71" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#0d1b16" media="(prefers-color-scheme: dark)">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="assets/icons/icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png">
  <style>
    :root{
      --bg:#f4f7f5; --card:#e7efe9; --accent:#5a7f71; --drop:#a8c8ba;
      --ink:#22302a; --muted:#5b6b64; --white:#fff; --success:#4ade80; --warning:#f59e0b;
      --shadow: 0 1px 0 rgba(0,0,0,.03);
      --shadow-hover: 0 4px 12px rgba(0,0,0,.1);
      --shadow-active: 0 2px 8px rgba(0,0,0,.15);
      --gradient-primary: linear-gradient(135deg, var(--accent) 0%, #4a9d7a 50%, var(--drop) 100%);
      --gradient-glass: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
      --safe-bottom: env(safe-area-inset-bottom);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0e1512; --card:#12211b; --accent:#8bd0b1; --drop:#3a6d5b;
        --ink:#ebf3f0; --muted:#a6bbb1; --white:#0e1512; --shadow: 0 1px 0 rgba(0,0,0,.2);
        --shadow-hover: 0 4px 16px rgba(0,0,0,.3);
        --shadow-active: 0 2px 12px rgba(0,0,0,.4);
        --gradient-glass: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
      }
      .tabbar{background:#0b100e;border-top-color:#1b2a24}
      .card,.timeline li{border-color:#1b2a24}
      .progress-bar{background:#1b2a24}
      
      /* Ensure all text is light in dark mode */
      body, h1, h2, h3, h4, h5, h6, p, span, div, label, button, input {
        color: var(--ink) !important;
      }
      
      /* Specific dark mode text overrides */
      .muted { color: var(--muted) !important; }
      .day-name, .task-time, .protein-ring-value { color: var(--accent) !important; }
      .btn.primary { color: #fff !important; }
      .btn { color: var(--ink) !important; }
      .exercise-name { color: var(--accent) !important; }
      .stat-number { color: var(--accent) !important; }
      
      /* Input fields in dark mode */
      .protein-input, .exercise-weight-input, .set-input, input[type="text"], input[type="number"], input[type="date"], input[type="time"] {
        background: var(--bg) !important;
        color: var(--ink) !important;
        border-color: var(--muted) !important;
      }
      
      /* Dialog backgrounds */
      dialog {
        background: var(--card) !important;
        color: var(--ink) !important;
      }
      
      /* Make sure placeholder text is visible */
      ::placeholder {
        color: var(--muted) !important;
        opacity: 0.8 !important;
      }
      
      /* Table text */
      .row div {
        color: var(--ink) !important;
      }
      
      /* Task text */
      .task-title, .task-note {
        color: var(--ink) !important;
      }
      .task-note {
        color: var(--muted) !important;
      }
    }
    
    /* Premium Animations & Transitions */
    *{box-sizing:border-box; transition: color 0.2s ease, background 0.2s ease, border-color 0.2s ease}
    html,body{height:100%}
    body{margin:0;font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;color:var(--ink);background:var(--bg)}
    
    /* Glass-morphism Effects */
    .glass-card {
      background: var(--gradient-glass);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    /* Enhanced Button Animations */
    .btn{
      background:none;border:1px solid color-mix(in oklab, black 8%, transparent); 
      padding:8px 12px; border-radius:10px; color:var(--ink);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-hover);
      border-color: color-mix(in oklab, var(--accent) 30%, transparent);
    }
    .btn:hover::before {
      left: 100%;
    }
    .btn:active {
      transform: translateY(0);
      box-shadow: var(--shadow-active);
    }
    
    .btn.primary{
      background:var(--gradient-primary); 
      border:none; 
      color:#fff;
      box-shadow: 0 2px 8px rgba(90, 127, 113, 0.3);
    }
    .btn.primary:hover {
      box-shadow: 0 4px 16px rgba(90, 127, 113, 0.4);
      transform: translateY(-2px);
    }
    .btn.primary:active {
      transform: translateY(-1px);
    }
    
    .btn.btn-success {
      background: var(--success) !important;
      color: white !important;
      border: none !important;
    }
    .btn.btn-success:hover {
      background: color-mix(in oklab, var(--success) 80%, black) !important;
      box-shadow: 0 4px 16px rgba(74, 222, 128, 0.4) !important;
    }
    
    .btn.ghost{border:none; color:var(--accent); font-weight:700; background:transparent}
    .btn.small{padding:4px 8px; font-size:0.8rem}
    .btn:focus-visible{outline:2px solid color-mix(in oklab, var(--accent) 70%, white); outline-offset:2px}
    
    /* Success Feedback Animation */
    @keyframes success-pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    .success-feedback {
      animation: success-pulse 0.3s ease;
    }
    
    /* Progress Animations */
    @keyframes progressFill {
      from { transform: scaleX(0); transform-origin: left; }
      to { transform: scaleX(1); transform-origin: left; }
    }
    .progress-fill {
      animation: progressFill 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Protein Ring Enhancement */
    @keyframes ringProgress {
      from { stroke-dasharray: 0 251.2; }
    }
    .protein-ring-progress {
      animation: ringProgress 1s ease-out;
      filter: drop-shadow(0 0 4px rgba(90, 127, 113, 0.3));
    }
    
    /* Floating Action Animations */
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-2px); }
    }
    .floating-element {
      animation: float 3s ease-in-out infinite;
    }
    
    /* Card Hover Effects */
    .card, .timeline li{
      background:var(--card); 
      border:1px solid color-mix(in oklab, black 8%, transparent); 
      border-radius:14px; padding:14px; margin:10px 4px; 
      box-shadow:var(--shadow);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .card:hover, .timeline li:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
      border-color: color-mix(in oklab, var(--accent) 20%, transparent);
    }
    
    .app-header{
      position:sticky; top:0; z-index:100; display:flex; justify-content:space-between; 
      align-items:center; gap:8px; padding:14px 16px; 
      background:linear-gradient(180deg, var(--card), color-mix(in oklab, var(--card) 70%, transparent)); 
      border-bottom:1px solid color-mix(in oklab, black 6%, transparent);
      backdrop-filter: blur(20px);
    }
    h1{margin:0; font-size:1.1rem}
    .muted{color:var(--muted)}
    .view{display:none; padding:12px 12px calc(84px + var(--safe-bottom))} .view.active{display:block}
    .day-header{display:flex; justify-content:space-between; align-items:center; margin:8px 4px 12px}
    .day-cluster{display:flex; flex-direction:column; gap:4px}
    .day-name{font-size:1.1rem; font-weight:800; color:var(--accent)} 
    .day-type{font-size:.92rem; color:var(--muted)} 
    .streak{
      font-size:.9rem; color:var(--accent); font-weight:700;
      padding: 4px 8px;
      background: color-mix(in oklab, var(--accent) 15%, transparent);
      border-radius: 12px;
      animation: float 2s ease-in-out infinite;
    }
    .picker{display:flex; gap:6px; flex-wrap:wrap}
    .chip{
      padding:6px 10px; border-radius:999px; 
      border:1px solid color-mix(in oklab, black 8%, transparent); 
      background:var(--card); font-size:.85rem; cursor:pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .chip:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .chip[aria-pressed="true"]{
      background:var(--gradient-primary); 
      color:#fff; border:none;
      box-shadow: 0 2px 8px rgba(90, 127, 113, 0.3);
    } 
    .today-chip{box-shadow:0 0 0 2px color-mix(in oklab, var(--accent) 50%, white)}
    .timeline{list-style:none; padding:0; margin:0}
    
    /* Enhanced Task Styling */
    .task{display:grid; grid-template-columns: 28px 1fr; align-items:start; gap:12px} 
    .task input[type="checkbox"]{
      width:22px;height:22px; accent-color:var(--accent); margin-top:2px;
      transition: transform 0.2s ease;
    }
    .task input[type="checkbox"]:checked {
      transform: scale(1.1);
    }
    .task label{display:block} 
    .task-time{
      font-weight:800; color:var(--accent); font-size:.95rem; margin-bottom:2px; 
      cursor:pointer; padding:2px 4px; border-radius:4px; 
      transition:all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .task-time:hover{
      background:color-mix(in oklab, var(--accent) 15%, transparent);
      transform: scale(1.02);
    }
    .task-title{font-weight:700; margin-bottom:2px} 
    .task-note{color:var(--muted); font-size:.9rem; line-height:1.4}
    .task-details{margin-top:8px; padding-top:8px; border-top:1px solid color-mix(in oklab, black 10%, transparent)} 
    .workout-details{
      background:color-mix(in oklab, var(--accent) 12%, transparent); 
      padding:10px; border-radius:8px;
      border-left: 3px solid var(--accent);
    }
    
    /* Enhanced Water Drops */
    .water{margin:18px 4px} 
    .water-head{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px} 
    .drops{display:flex; gap:6px; flex-wrap:wrap}
    .drop{
      width:24px; height:32px; border-radius:12px; 
      background:color-mix(in oklab, var(--accent) 15%, transparent); 
      border:1px solid color-mix(in oklab, black 8%, transparent); 
      cursor:pointer; position:relative; 
      transition:all .2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .drop:hover {
      transform: scale(1.1) translateY(-1px);
    }
    .drop.filled{
      background:var(--drop); 
      transform:scale(1.05);
      box-shadow: 0 2px 8px rgba(168, 200, 186, 0.4);
    } 
    .drop::after{
      content:""; position:absolute; top:6px; left:8px; width:8px; height:8px; 
      border-radius:50%; background:rgba(255,255,255,.9);
      transition: all 0.2s ease;
    }
    .drop.filled::after {
      animation: float 2s ease-in-out infinite;
    }
    
    .progress-bar{
      width:100%; height:8px; background:#dfe9e3; border-radius:6px; 
      overflow:hidden; margin-top:6px;
      position: relative;
    } 
    .progress-fill{
      height:100%; width:0; 
      background:linear-gradient(90deg, var(--accent), var(--success)); 
      transition:width .25s ease;
      position: relative;
    }
    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    /* Protein Goal Ring Enhancement */
    .protein-ring-container{
      position:relative; display:inline-flex; align-items:center; 
      justify-content:center; margin:18px 4px;
    }
    .protein-ring{width:80px; height:80px; position:relative}
    .protein-ring svg{width:100%; height:100%; transform:rotate(-90deg)}
    .protein-ring-bg{fill:none; stroke:color-mix(in oklab, var(--accent) 20%, transparent); stroke-width:6}
    .protein-ring-progress{
      fill:none; stroke:url(#proteinGradient); stroke-width:6; stroke-linecap:round; 
      transition:stroke-dasharray 0.3s ease;
      filter: drop-shadow(0 0 4px rgba(90, 127, 113, 0.3));
    }
    .protein-ring-center{
      position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); 
      text-align:center;
    }
    .protein-ring-value{
      font-size:0.9rem; font-weight:800; color:var(--accent);
      transition: all 0.3s ease;
    }
    .protein-ring-label{font-size:0.7rem; color:var(--muted)}
    .protein-input-container{display:flex; gap:8px; align-items:center; margin-top:8px}
    .protein-input{
      width:60px; padding:4px 6px; 
      border:1px solid color-mix(in oklab, black 10%, transparent); 
      border-radius:4px; background:var(--white); text-align:center;
      transition: all 0.2s ease;
    }
    .protein-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px color-mix(in oklab, var(--accent) 20%, transparent);
    }
    
    @media (prefers-reduced-motion: reduce){ 
      .drop, .progress-fill, .btn, .card, .chip, .task-time {transition:none} 
      .floating-element, .drop.filled::after {animation: none}
    }
    .stats-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin:10px 4px} 
    .stat-card{text-align:center} 
    .stat-number{
      font-size:1.4rem; font-weight:800; color:var(--accent);
      transition: all 0.3s ease;
    }
    .stat-card:hover .stat-number {
      transform: scale(1.1);
      color: var(--success);
    }
    
    .tabbar{
      position:fixed; inset-inline:0; bottom:0; z-index:101; display:flex; 
      background:var(--card); border-top:1px solid color-mix(in oklab, black 8%, transparent); 
      padding-bottom:var(--safe-bottom);
      backdrop-filter: blur(20px);
    }
    @media (prefers-color-scheme: dark){ 
      .tabbar{background:#0b100e} 
    }
    .tabbar button{
      flex:1; padding:12px 8px; background:none; border:none; 
      color:var(--muted); font-weight:700; font-size:.85rem;
      transition: all 0.2s ease;
      position: relative;
    } 
    .tabbar button:hover {
      color: var(--accent);
      background: color-mix(in oklab, var(--accent) 8%, transparent);
    }
    .tabbar button.active{
      color:var(--accent);
    }
    .tabbar button.active::after {
      content: '';
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 20px;
      height: 2px;
      background: var(--accent);
      border-radius: 2px;
    }
    
    /* Dialog styles */
    dialog{border:none; border-radius:14px; overflow:hidden; background:var(--card); color:var(--ink)} 
    dialog::backdrop{background:rgba(0,0,0,0.5)}
    dialog form{padding:16px} 
    #timeForm .row{display:grid; grid-template-columns: 1fr 120px; gap:8px; margin:6px 0}
    .today-highlight{outline:2px solid color-mix(in oklab, var(--accent) 60%, white); border-radius:12px; box-shadow:0 0 0 4px color-mix(in oklab, var(--accent) 12%, transparent) inset}

    /* Enhanced Exercise Logging */
    .exercise-log{margin:12px 4px}
    .exercise-log-simple{margin:8px 0}
    .exercise-entry{background:var(--card); border:1px solid color-mix(in oklab, black 8%, transparent); border-radius:12px; padding:12px; margin:8px 0}
    .exercise-entry-simple{display:grid; grid-template-columns:1fr 100px 60px; gap:8px; align-items:center; background:var(--card); border:1px solid color-mix(in oklab, black 8%, transparent); border-radius:8px; padding:8px; margin:4px 0}
    .exercise-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px}
    .exercise-name{font-weight:700; color:var(--accent)}
    .exercise-weight-input{padding:6px; border:1px solid color-mix(in oklab, black 10%, transparent); border-radius:6px; background:var(--white); text-align:center; width:100%}
    .pr-badge{background:color-mix(in oklab, var(--success) 20%, transparent); color:var(--success); padding:2px 6px; border-radius:999px; font-size:0.7rem; font-weight:700}
    .sets-container{display:grid; gap:6px}
    .set-row{display:grid; grid-template-columns:40px 1fr 1fr 1fr 40px; gap:8px; align-items:center; padding:4px 0}
    .set-input{padding:6px; border:1px solid color-mix(in oklab, black 10%, transparent); border-radius:6px; background:var(--white); text-align:center; width:100%}
    .add-set-btn{grid-column:1/-1; margin-top:8px}
    .remove-set-btn{background:none; border:none; color:var(--warning); cursor:pointer; font-size:1.2rem; display:flex; align-items:center; justify-content:center}
    .today-exercises{display:grid; gap:6px; margin-top:8px}
    .today-exercise-item{display:flex; justify-content:space-between; align-items:center; padding:6px 10px; background:color-mix(in oklab, var(--accent) 8%, transparent); border-radius:6px; font-size:0.9rem}
    .quick-add-container{display:flex; gap:6px; margin-top:8px}
    
    /* Achievement Badges */
    .achievement-badge{
      display:inline-flex; align-items:center; gap:4px;
      background:var(--gradient-primary); color:white; 
      padding:4px 8px; border-radius:12px; font-size:0.75rem; font-weight:600;
      box-shadow: 0 2px 4px rgba(90, 127, 113, 0.3);
      animation: bounce 0.5s ease;
    }
    
    @keyframes bounce {
      0%, 20%, 60%, 100% { transform: translateY(0); }
      40% { transform: translateY(-4px); }
      80% { transform: translateY(-2px); }
    }

    /* Resources table */
    .resource-section{margin:12px 4px}
    .table{display:grid; gap:6px} .row{display:grid; grid-template-columns: 110px 1fr 90px 140px 1fr; gap:6px}
    .row div{background:var(--card); border:1px solid color-mix(in oklab, black 8%, transparent); border-radius:10px; padding:10px; text-align:center} .row.head div{font-weight:800}
    @media (max-width: 480px){ .row{grid-template-columns: 90px 1fr;} .row div:nth-child(n+3){display:none} }

    /* Log form */
    .form{display:grid; gap:10px; margin:8px 4px}
    .field{display:grid; grid-template-columns: 1fr 120px; align-items:center; gap:8px; background:var(--card); border:1px solid color-mix(in oklab, black 8%, transparent); border-radius:12px; padding:10px}
    .field input{width:100%; padding:8px; border-radius:8px; border:1px solid color-mix(in oklab, black 10%, transparent); background:var(--white); color:var(--ink)}
    .field small{color:var(--muted)}
    .form h3{margin:6px 4px}
    .grid-2{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .badge{display:inline-block; padding:3px 8px; border-radius:999px; background:var(--card); border:1px solid color-mix(in oklab, black 8%, transparent); color:var(--muted); font-size:.8rem}
    .pill{display:inline-block; padding:4px 8px; border-radius:999px; background:color-mix(in oklab, var(--accent) 15%, transparent); color:var(--accent); font-weight:700; font-size:.8rem}
    .section-title{display:flex; justify-content:space-between; align-items:center; gap:8px; margin:10px 4px}
    canvas{width:100%; height:200px; background:var(--card); border:1px solid color-mix(in oklab, black 8%, transparent); border-radius:12px}
    
    /* PR Display */
    .pr-display{margin:12px 4px}
    .pr-grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:8px}
    .pr-card{background:var(--card); border:1px solid color-mix(in oklab, black 8%, transparent); border-radius:12px; padding:12px; text-align:center}
    .pr-lift{font-size:0.8rem; color:var(--muted); margin-bottom:4px}
    .pr-value{font-size:1.2rem; font-weight:800; color:var(--accent)}
    .pr-date{font-size:0.7rem; color:var(--muted); margin-top:4px}
  </style>
</head>
<body>
  <header class="app-header" role="banner">
    <h1>Health & Fitness Tracker</h1>
    <div class="picker" role="tablist" aria-label="Pick a day to preview">
      <button class="chip" data-day="0" aria-pressed="false" aria-label="Sunday">Sun</button>
      <button class="chip" data-day="1" aria-pressed="false" aria-label="Monday">Mon</button>
      <button class="chip" data-day="2" aria-pressed="false" aria-label="Tuesday">Tue</button>
      <button class="chip" data-day="3" aria-pressed="false" aria-label="Wednesday">Wed</button>
      <button class="chip" data-day="4" aria-pressed="false" aria-label="Thursday">Thu</button>
      <button class="chip" data-day="5" aria-pressed="false" aria-label="Friday">Fri</button>
      <button class="chip" data-day="6" aria-pressed="false" aria-label="Saturday">Sat</button>
    </div>
  </header>

  <!-- Today View -->
  <main id="view-today" class="view active" role="main">
    <div class="day-header" aria-live="polite">
      <div class="day-cluster">
        <div class="day-name" id="dayName">Monday</div>
        <div class="day-type" id="dayType">Full Body Strength ‚Ä¢ Dose day</div>
        <div class="muted" id="weekLabel">Week 1</div>
      </div>
      <div class="streak" aria-label="Current streak"><span aria-hidden="true">üî•</span> <span id="streakCount">0</span> day streak</div>
    </div>

    <ul id="timeline" class="timeline" aria-label="Today timeline"></ul>

    <section class="water" aria-labelledby="waterHeading">
      <div class="water-head">
        <h2 id="waterHeading">Hydration</h2>
        <div class="muted"><span id="waterCurrent" aria-live="polite">0</span>/8 glasses</div>
      </div>
      <div id="waterDrops" class="drops" role="group" aria-label="Water cups"></div>
      <div class="progress-bar" aria-hidden="true"><div id="waterProgress" class="progress-fill"></div></div>
      <div class="quick-add-container" style="display:flex; gap:6px; margin-top:8px; justify-content:center">
        <button class="btn small" onclick="addQuickWater(1)">+1 glass</button>
        <button class="btn small" onclick="addQuickWater(2)">+2 glasses</button>
        <button class="btn small" onclick="addQuickWater(-1)">-1 glass</button>
      </div>
    </section>

    <section class="protein-ring-container" aria-labelledby="proteinHeading">
      <div class="protein-ring">
        <svg viewBox="0 0 100 100">
          <defs>
            <linearGradient id="proteinGradient" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" style="stop-color:var(--accent);stop-opacity:1" />
              <stop offset="100%" style="stop-color:var(--success);stop-opacity:1" />
            </linearGradient>
          </defs>
          <circle class="protein-ring-bg" cx="50" cy="50" r="40"></circle>
          <circle class="protein-ring-progress" cx="50" cy="50" r="40" id="proteinProgressRing"></circle>
        </svg>
        <div class="protein-ring-center">
          <div class="protein-ring-value" id="proteinCurrent">0</div>
          <div class="protein-ring-label">protein</div>
        </div>
      </div>
      <div>
        <h3 id="proteinHeading" style="margin:0 0 4px; font-size:1rem">Protein Goal</h3>
        <div class="protein-input-container">
          <input type="number" id="proteinGoalInput" class="protein-input" placeholder="Goal" min="50" max="300" step="5">
          <button class="btn small" onclick="updateProteinGoal()">Set</button>
        </div>
        <div class="muted" style="font-size:0.8rem; margin-top:4px">
          <span id="proteinGoalText">Set your daily goal</span>
        </div>
        <div class="quick-add-container" style="display:flex; gap:6px; margin-top:8px; flex-wrap:wrap">
          <button class="btn small" onclick="addQuickProtein(20)">+20g</button>
          <button class="btn small" onclick="addQuickProtein(25)">+25g</button>
          <button class="btn small" onclick="addQuickProtein(30)">+30g</button>
          <button class="btn small" onclick="addQuickProtein(40)">+40g</button>
        </div>
      </div>
    </section>

    <section class="card" style="margin:18px 4px">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
        <h3 style="margin:0">Quick Exercise Log</h3>
        <button class="btn small" onclick="showQuickExerciseDialog()">+ Log Lift</button>
      </div>
      <div id="todayExercises" class="today-exercises"></div>
    </section>
  </main>

  <!-- Week View -->
  <main id="view-week" class="view">
    <div class="stats-grid" aria-label="Weekly stats">
      <div class="card stat-card"><div class="stat-number" id="weekCompleted">0</div><div class="muted">Days Completed</div></div>
      <div class="card stat-card"><div class="stat-number" id="weekPercentage">0%</div><div class="muted">Week Progress</div></div>
    </div>
    
    <!-- Weekly Body Metrics -->
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
        <h3 style="margin:0">Weekly Body Metrics</h3>
        <div class="muted" style="font-size:0.8rem">Sunday Morning Task</div>
      </div>
      <div class="form" style="margin:0">
        <div class="grid-2" style="gap:8px">
          <div class="field" style="padding:8px"><label for="weeklyWeight">Weight (lb)</label><input id="weeklyWeight" type="number" step="0.1" inputmode="decimal"></div>
          <div class="field" style="padding:8px"><label for="weeklyWaist">Waist (in)</label><input id="weeklyWaist" type="number" step="0.1" inputmode="decimal"></div>
        </div>
        <div class="field" style="padding:8px; grid-column:1/-1"><label for="weeklyHips">Hips (in)</label><input id="weeklyHips" type="number" step="0.1" inputmode="decimal"></div>
        <button id="saveWeeklyMetrics" class="btn primary" style="margin-top:8px">Save Metrics</button>
      </div>
    </div>
    
    <div id="weekOverview" class="timeline"></div>
    <div class="card">
      <h2>Weekly Schedule</h2>
      <div id="weekSchedule"></div>
    </div>
    <button id="resetWeekBtn" class="btn" style="margin:12px 4px">Reset Week</button>
  </main>

  <!-- Resources -->
  <main id="view-resources" class="view">
    <section class="card resource-section">
      <h2>4-Week Fat Loss Calendar</h2>
      <p>You'll have check boxes for: Dose ‚úî, Workout ‚úî, Cardio ‚úî, Nutrition ‚úî each day.</p>
      <p><strong>Legend:</strong> üèã Strength ‚Ä¢ ‚ö° HIIT ‚Ä¢ üö∂ Active Recovery ‚Ä¢ ‚ùå Rest</p>
      <div class="table">
        <div class="row head"><div>Day</div><div>Training</div><div>Sermorelin</div><div>Cardio</div><div>Nutrition Focus</div></div>
        <div class="row"><div>Mon üèã</div><div>Full Body Strength</div><div>‚úî</div><div>‚Äî</div><div>Mod carbs post‚Äëworkout</div></div>
        <div class="row"><div>Tue ‚ö°</div><div>HIIT + Core</div><div>‚úî</div><div>‚Äî</div><div>Low carb PM</div></div>
        <div class="row"><div>Wed üèã</div><div>Upper Strength + Cardio</div><div>‚úî</div><div>20 min steady</div><div>Mod carbs post‚Äëworkout</div></div>
        <div class="row"><div>Thu ‚ö°</div><div>HIIT</div><div>‚úî</div><div>‚Äî</div><div>Low carb PM</div></div>
        <div class="row"><div>Fri üèã</div><div>Lower Strength + Cardio</div><div>‚úî</div><div>20‚Äì30 min steady</div><div>Mod carbs post‚Äëworkout</div></div>
        <div class="row"><div>Sat üö∂</div><div>Active Recovery</div><div>‚ùå</div><div>Fasted walk</div><div>Low carb day</div></div>
        <div class="row"><div>Sun ‚ùå</div><div>Rest</div><div>‚ùå</div><div>Light walk optional</div><div>Low carb day</div></div>
      </div>
    </section>

    <section class="card resource-section">
      <h2>Detailed Workouts (With Alternatives)</h2>
      <h3>MONDAY ‚Äì Full Body Strength</h3>
      <p><em>Main Routine (3 sets each, 8‚Äì12 reps, 60‚Äì90 sec rest)</em></p>
      <ul>
        <li>Barbell Back Squat ‚Üí alt: Dumbbell Goblet Squat</li>
        <li>Bench Press ‚Üí alt: Dumbbell Chest Press</li>
        <li>Bent-Over Barbell Row ‚Üí alt: One-Arm Dumbbell Row</li>
        <li>Seated Overhead Press ‚Üí alt: Arnold Press</li>
        <li>Romanian Deadlift ‚Üí alt: Kettlebell Deadlift</li>
        <li>Plank (3√ó30‚Äì60 sec) ‚Üí alt: Dead Bug</li>
      </ul>

      <h3>TUESDAY ‚Äì HIIT + Core</h3>
      <p><em>HIIT (15‚Äì20 min)</em></p>
      <ul>
        <li>20 sec all-out sprint (bike/treadmill/rower) ‚Üí 40 sec rest √ó 8‚Äì10</li>
      </ul>
      <p><em>Core Finisher (3 rounds)</em></p>
      <ul>
        <li>Hanging Knee Raises √ó 12 ‚Üí alt: Lying Leg Raise</li>
        <li>Russian Twists √ó 20 (10/side) ‚Üí alt: Cable Woodchop</li>
        <li>Side Plank √ó 30 sec/side</li>
      </ul>

      <h3>WEDNESDAY ‚Äì Upper Strength + Cardio</h3>
      <p><em>Strength (3√ó8‚Äì12)</em></p>
      <ul>
        <li>Pull-Ups or Assisted Pull-Up ‚Üí alt: Lat Pulldown</li>
        <li>Incline Dumbbell Press ‚Üí alt: Barbell Incline Press</li>
        <li>Barbell Row ‚Üí alt: Single-Arm Row</li>
        <li>Dumbbell Lateral Raise ‚Üí alt: Cable Lateral Raise</li>
        <li>Tricep Dips ‚Üí alt: Cable Rope Pushdown</li>
        <li>Bicep Curl ‚Üí alt: Hammer Curl</li>
      </ul>
      <p><em>Cardio ‚Äì 20 min steady pace after lifting</em></p>

      <h3>THURSDAY ‚Äì HIIT</h3>
      <ul>
        <li>30 sec high-intensity battle ropes ‚Üí 30 sec rest √ó 10 rounds</li>
        <li><strong>or</strong> Sprint Intervals: 15 sec all-out / 45 sec walk √ó 10 rounds</li>
      </ul>

      <h3>FRIDAY ‚Äì Lower Strength + Cardio</h3>
      <p><em>Strength (3√ó8‚Äì12)</em></p>
      <ul>
        <li>Deadlift ‚Üí alt: Trap Bar Deadlift</li>
        <li>Walking Lunges (per leg) ‚Üí alt: Step-Ups</li>
        <li>Hip Thrusts ‚Üí alt: Glute Bridge</li>
        <li>Bulgarian Split Squat ‚Üí alt: Goblet Squat</li>
        <li>Standing Calf Raise ‚Üí alt: Seated Calf Raise</li>
      </ul>
      <p><em>Cardio ‚Äì 20‚Äì30 min steady pace after lifting</em></p>

      <h3>SATURDAY ‚Äì Active Recovery</h3>
      <ul>
        <li>20‚Äì30 min fasted walk or yoga/stretching</li>
        <li>Focus on mobility and recovery</li>
      </ul>
    </section>

    <section class="card resource-section">
      <h2>Nutrition & Snack Options</h2>
      <h3>Protein Snack Options</h3>
      <ul>
        <li>Whey isolate (110‚Äì130 cal, 25g protein) with water or unsweetened almond milk</li>
        <li>Greek yogurt (150g, 100 cal, 18g protein) + cinnamon</li>
        <li>Cottage cheese (¬Ω cup, 90 cal, 14g protein) with berries</li>
        <li>Turkey or chicken slices with mustard</li>
        <li>Hard-boiled eggs (add hot sauce or spices)</li>
        <li>Protein bars (aim for 18‚Äì22g protein, &lt;8g sugar)</li>
      </ul>

      <h3>Breakfast Ideas (post‚Äëworkout small carbs)</h3>
      <ul>
        <li>2 eggs + 3 egg whites + ¬Ω banana</li>
        <li>Protein shake + small handful of berries</li>
        <li>Greek yogurt + chia seeds + blueberries</li>
      </ul>

      <h3>Lunch Ideas (moderate carbs)</h3>
      <ul>
        <li>Chicken breast + quinoa + roasted veggies</li>
        <li>Salmon + sweet potato + spinach</li>
        <li>Lean ground turkey + brown rice + broccoli</li>
      </ul>

      <h3>Dinner Ideas (low carb, protein + fats)</h3>
      <ul>
        <li>Grilled chicken + asparagus + olive oil</li>
        <li>White fish + zucchini noodles + pesto</li>
        <li>Lean steak + roasted Brussels sprouts</li>
      </ul>
    </section>
  </main>

  <!-- Log -->
  <main id="view-log" class="view">
    <div class="section-title">
      <h2>Daily Log</h2>
      <button id="saveLogBtn" class="btn primary">Save</button>
    </div>
    <div class="form" aria-label="Daily measurements and habits">
      <div class="grid-2">
        <div class="field"><label for="logDate">Date</label><input id="logDate" type="date"></div>
        <div class="field"><label for="logProtein">Protein (g)</label><input id="logProtein" type="number" step="1" inputmode="numeric"></div>
      </div>
      <div class="grid-2">
        <div class="field"><label for="logSleep">Sleep (hrs)</label><input id="logSleep" type="number" step="0.1" inputmode="decimal"></div>
        <div class="field"><label for="logSteps">Steps</label><input id="logSteps" type="number" step="1" inputmode="numeric"></div>
      </div>
      <div class="field"><label for="logMood">Mood / Energy (1‚Äì5)</label><input id="logMood" type="number" min="1" max="5" step="1" inputmode="numeric"></div>

      <h3>Exercise Max Weight Log</h3>
      <div id="exerciseLog" class="exercise-log-simple"></div>
      <button id="addExerciseBtn" class="btn" style="margin:8px 0">Add Exercise</button>
    </div>

    <div class="section-title">
      <h2>Backup</h2>
      <div>
        <button id="exportBtn" class="btn">Export</button>
        <label class="btn" style="cursor:pointer">
          Import <input id="importInput" type="file" accept="application/json" style="display:none">
        </label>
      </div>
    </div>
    <p class="muted" style="margin:0 4px 8px">Export creates a JSON backup of all your app data (schedule, checks, logs). Import restores it.</p>
  </main>

  <!-- Progress -->
  <main id="view-progress" class="view">
    <div class="section-title">
      <h2>Progress</h2>
      <span id="progressBadges"></span>
    </div>

    <div class="pr-display">
      <h3>Personal Records</h3>
      <div id="prGrid" class="pr-grid"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px">Weight Trend</h3>
      <canvas id="chartWeight" width="400" height="220" aria-label="Weight chart"></canvas>
      <div class="muted" style="margin-top:6px"><span class="badge" id="weightChange">‚Äî</span></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px">Waist Trend</h3>
      <canvas id="chartWaist" width="400" height="220" aria-label="Waist chart"></canvas>
      <div class="muted" style="margin-top:6px"><span class="badge" id="waistChange">‚Äî</span></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px">Weekly Summary</h3>
      <div class="grid-2">
        <div><div class="pill" id="sumWorkouts">‚Äî</div><small class="muted">Workouts completed</small></div>
        <div><div class="pill" id="sumProtein">‚Äî</div><small class="muted">Avg protein/day</small></div>
        <div><div class="pill" id="sumSleep">‚Äî</div><small class="muted">Avg sleep (hrs)</small></div>
        <div><div class="pill" id="sumWater">‚Äî</div><small class="muted">Avg water (glasses)</small></div>
      </div>
    </div>
  </main>

  <nav class="tabbar" role="navigation" aria-label="App tabs">
    <button data-target="view-today" class="active" aria-controls="view-today" aria-selected="true">Today</button>
    <button data-target="view-week" aria-controls="view-week" aria-selected="false">Week</button>
    <button data-target="view-resources" aria-controls="view-resources" aria-selected="false">Resources</button>
    <button data-target="view-log" aria-controls="view-log" aria-selected="false">Log</button>
    <button data-target="view-progress" aria-controls="view-progress" aria-selected="false">Progress</button>
  </nav>

  <!-- Time Edit Dialog -->
  <dialog id="timeEditDialog">
    <form method="dialog">
      <h3>Edit Time</h3>
      <div class="row">
        <label for="timeInput">Time:</label>
        <input id="timeInput" type="time" required>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:16px">
        <button type="button" class="btn" onclick="closeTimeDialog()">Cancel</button>
        <button type="submit" class="btn primary">Save</button>
      </div>
    </form>
  </dialog>

  <!-- Exercise Dialog -->
  <dialog id="exerciseDialog">
    <form method="dialog">
      <h3>Add Exercise</h3>
      <div class="row">
        <label for="exerciseNameInput">Exercise:</label>
        <input id="exerciseNameInput" type="text" required placeholder="e.g., Bench Press">
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:16px">
        <button type="button" class="btn" onclick="closeExerciseDialog()">Cancel</button>
        <button type="submit" class="btn primary">Add</button>
      </div>
    </form>
  </dialog>

  <!-- Quick Exercise Dialog -->
  <dialog id="quickExerciseDialog">
    <form method="dialog" onsubmit="saveQuickExercise(); return false;">
      <h3>Quick Exercise Log</h3>
      <div class="row" style="margin:8px 0">
        <label for="quickExerciseName">Exercise:</label>
        <input id="quickExerciseName" type="text" required placeholder="e.g., Bench Press">
      </div>
      <div class="row" style="margin:8px 0">
        <label for="quickExerciseWeight">Max Weight (lbs):</label>
        <input id="quickExerciseWeight" type="number" required placeholder="135" step="0.5">
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:16px">
        <button type="button" class="btn" onclick="closeQuickExerciseDialog()">Cancel</button>
        <button type="submit" class="btn primary">Log Exercise</button>
      </div>
    </form>
  </dialog>

  <script>
    const WEEKLY_SCHEDULE = {
      0:{type:"Rest Day",workoutType:"rest",dose:false,schedule:[
        {key:"hydrate",time:"08:00",title:"Wake & Hydrate",note:"16‚Äì20 oz water"},
        {key:"activity",time:"09:00",title:"Light Activity",note:"Light mobility or leisure activity"},
        {key:"breakfast",time:"09:30",title:"Breakfast",note:"Protein + fats"},
        {key:"lunch",time:"12:30",title:"Lunch",note:"Protein + greens (low carb)"},
        {key:"dinner",time:"18:00",title:"Dinner",note:"Protein + veggies (low carb)"},
        {key:"sleep",time:"22:00",title:"Wind Down",note:"No food 2 hrs before bed"}
      ]},
      1:{type:"Full Body Strength",workoutType:"strength",dose:true,schedule:[
        {key:"hydrate",time:"06:15",title:"Wake & Hydrate",note:"16‚Äì20 oz water"},
        {key:"workout",time:"06:30",title:"Full Body Workout",note:"45‚Äì60 min strength",details:"Barbell Back Squat ‚Üí alt: Goblet Squat; Bench Press ‚Üí alt: DB Chest; Bent‚ÄëOver Row ‚Üí alt: 1‚ÄëArm DB Row; Seated OHP ‚Üí alt: Arnold Press; RDL ‚Üí alt: Kettlebell Deadlift; Plank 3√ó30‚Äì60s ‚Üí alt: Dead Bug"},
        {key:"postwo",time:"07:45",title:"Post‚ÄëWorkout",note:"25‚Äì30g protein + small carbs (banana/berries)"},
        {key:"snack1",time:"10:30",title:"Snack",note:"Protein + fats (turkey + avocado)"},
        {key:"lunch",time:"13:00",title:"Lunch",note:"Lean protein + moderate carbs + veggies"},
        {key:"snack2",time:"16:30",title:"Snack",note:"Protein + veggies or nuts"},
        {key:"dinner",time:"19:00",title:"Dinner",note:"Protein + low‚Äëcarb veggies + healthy fats"},
        {key:"cutoff",time:"21:45",title:"Food Cutoff",note:"No food after this time"},
        {key:"dose",time:"22:30",title:"Sermorelin 40 mg",note:""},
        {key:"sleep",time:"22:35",title:"Sleep",note:""}
      ]},
      2:{type:"HIIT + Core",workoutType:"hiit",dose:true,schedule:[
        {key:"hydrate",time:"06:15",title:"Wake & Hydrate",note:"16‚Äì20 oz water"},
        {key:"workout",time:"06:30",title:"HIIT + Core",note:"15‚Äì20 min HIIT + core",details:"Sprints 20s all‚Äëout / 40s rest √ó 8‚Äì10 ‚Ä¢ Core: Knee Raises √ó12, Russian Twists √ó20, Side Plank √ó30s/side"},
        {key:"postwo",time:"06:55",title:"Post‚ÄëWorkout",note:"Protein + small carbs"},
        {key:"snack1",time:"10:00",title:"Snack",note:"Protein + fats"},
        {key:"lunch",time:"13:00",title:"Lunch",note:"Lean protein + moderate carbs"},
        {key:"snack2",time:"16:00",title:"Snack",note:"Protein + veggies"},
        {key:"dinner",time:"19:00",title:"Dinner",note:"Protein + greens + olive oil"},
        {key:"cutoff",time:"21:45",title:"Food Cutoff",note:"No food after this time"},
        {key:"dose",time:"22:30",title:"Sermorelin 40 mg",note:""}
      ]},
      3:{type:"Upper Strength + Cardio",workoutType:"strength",dose:true,schedule:[
        {key:"hydrate",time:"06:15",title:"Wake & Hydrate",note:"16‚Äì20 oz water"},
        {key:"workout",time:"06:30",title:"Upper + 20m Cardio",note:"45 min upper + 20 min steady",details:"Pull‚ÄëUps ‚Üí alt: Lat Pulldown; Incline DB Press ‚Üí alt: Barbell Incline; Barbell Row ‚Üí alt: Single‚ÄëArm Row; DB Laterals ‚Üí alt: Cable Laterals; Dips ‚Üí alt: Rope Pushdown; Curls ‚Üí alt: Hammer Curl"},
        {key:"postwo",time:"07:45",title:"Post‚ÄëWorkout",note:"Protein + moderate carbs"},
        {key:"snack1",time:"10:30",title:"Snack",note:"Protein + fats"},
        {key:"lunch",time:"13:00",title:"Lunch",note:"Lean protein + moderate carbs"},
        {key:"snack2",time:"16:30",title:"Snack",note:"Protein + veggies"},
        {key:"dinner",time:"19:00",title:"Dinner",note:"Protein + low‚Äëcarb veggies + fats"},
        {key:"cutoff",time:"21:45",title:"Food Cutoff",note:"No food after this time"},
        {key:"dose",time:"22:30",title:"Sermorelin 40 mg",note:""}
      ]},
      4:{type:"HIIT",workoutType:"hiit",dose:true,schedule:[
        {key:"hydrate",time:"06:15",title:"Wake & Hydrate",note:"16‚Äì20 oz water"},
        {key:"workout",time:"06:30",title:"HIIT Training",note:"15 min high intensity",details:"Battle ropes 30s on / 30s off √ó 10 or Sprints 15s all‚Äëout / 45s walk √ó 10"},
        {key:"postwo",time:"06:50",title:"Post‚ÄëWorkout",note:"Protein + small carbs"},
        {key:"snack1",time:"10:00",title:"Snack",note:"Protein + fats"},
        {key:"lunch",time:"13:00",title:"Lunch",note:"Lean protein + moderate carbs"},
        {key:"snack2",time:"16:00",title:"Snack",note:"Protein + veggies"},
        {key:"dinner",time:"19:00",title:"Dinner",note:"Protein + greens + olive oil"},
        {key:"cutoff",time:"21:45",title:"Food Cutoff",note:"No food after this time"},
        {key:"dose",time:"22:30",title:"Sermorelin 40 mg",note:""}
      ]},
      5:{type:"Lower Strength + Cardio",workoutType:"strength",dose:true,schedule:[
        {key:"hydrate",time:"06:15",title:"Wake & Hydrate",note:"16‚Äì20 oz water"},
        {key:"workout",time:"06:30",title:"Lower + 20‚Äì30m Cardio",note:"45 min lower + 20‚Äì30 min steady",details:"Deadlift ‚Üí alt: Trap Bar; Walking Lunges ‚Üí alt: Step‚ÄëUps; Hip Thrust ‚Üí alt: Glute Bridge; Bulgarian Split Squat ‚Üí alt: Goblet Squat; Standing Calf Raise ‚Üí alt: Seated Calf Raise"},
        {key:"postwo",time:"07:45",title:"Post‚ÄëWorkout",note:"Protein + moderate carbs"},
        {key:"snack1",time:"10:30",title:"Snack",note:"Protein + fats"},
        {key:"lunch",time:"13:00",title:"Lunch",note:"Lean protein + moderate carbs"},
        {key:"snack2",time:"16:30",title:"Snack",note:"Protein + veggies"},
        {key:"dinner",time:"19:00",title:"Dinner",note:"Protein + low‚Äëcarb veggies + fats"},
        {key:"cutoff",time:"21:45",title:"Food Cutoff",note:"No food after this time"},
        {key:"dose",time:"22:30",title:"Sermorelin 40 mg",note:""}
      ]},
      6:{type:"Active Recovery",workoutType:"recovery",dose:false,schedule:[
        {key:"hydrate",time:"07:00",title:"Wake & Hydrate",note:"16‚Äì20 oz water"},
        {key:"activity",time:"07:30",title:"Fasted Walk / Yoga",note:"20‚Äì30 min light activity"},
        {key:"breakfast",time:"09:00",title:"Breakfast",note:"Protein + fats (low carb)"},
        {key:"lunch",time:"12:30",title:"Lunch",note:"Protein + greens (low carb)"},
        {key:"dinner",time:"18:00",title:"Dinner",note:"Protein + veggies (low carb)"},
        {key:"sleep",time:"22:00",title:"Wind Down",note:"No food 2 hrs before bed"}
      ]}
    };
    
    const ICONS={strength:"üèãÔ∏è",hiit:"‚ö°",recovery:"üö∂",rest:"üò¥"}; 
    const DAY_NAMES=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
    let currentEditingTime = null;
    let currentEditingExerciseId = null;

    // ---- State helpers ----
    function loadState(){ try{return JSON.parse(localStorage.getItem("mfl_state_v23b")||"{}")}catch(e){return {}}}
    function saveState(s){ localStorage.setItem("mfl_state_v23b", JSON.stringify(s)) }
    function todayKey(){ return new Date().toISOString().slice(0,10) }
    function getDow(){ return Number(document.querySelector('.chip[aria-pressed="true"]')?.dataset.day ?? new Date().getDay()) }
    
    function toHuman(hm){ 
      if(!hm||hm.includes(':')===false) return hm; 
      const [h,m]=hm.split(':').map(Number); 
      const d=new Date(); d.setHours(h); d.setMinutes(m); 
      return d.toLocaleTimeString([], {hour:'numeric',minute:'2-digit'}) 
    }

    function initDefaults(){
      const s=loadState();
      if(!s.waterGoal) s.waterGoal=8;
      if(!s.proteinGoal) s.proteinGoal=120;
      if(!s.water) s.water={};
      if(!s.checks) s.checks={}; // dateKey -> { itemKey: true }
      if(!s.streak) s.streak=0;
      if(!s.weekStart){
        const t=new Date(); const mon=new Date(t); const dow=mon.getDay(); const diff=(dow===0?-6:1)-dow; mon.setDate(t.getDate()+diff); s.weekStart=mon.toISOString().slice(0,10);
      }
      if(!s.logs) s.logs={};
      if(!s.prs) s.prs={};
      if(!s.exercises) s.exercises={};
      if(!s.customTimes) s.customTimes={};
      saveState(s);
    }

    // ---- Protein Ring Functions ----
    function updateProteinRing() {
      const s = loadState();
      const dk = todayKey();
      const current = s.logs[dk]?.protein || 0;
      const goal = s.proteinGoal || 120;
      const percentage = Math.min((current / goal) * 100, 100);
      
      document.getElementById('proteinCurrent').textContent = current + 'g';
      document.getElementById('proteinGoalText').textContent = `Goal: ${goal}g (${Math.round(percentage)}%)`;
      
      const ring = document.getElementById('proteinProgressRing');
      const circumference = 2 * Math.PI * 40;
      const strokeDasharray = `${(percentage / 100) * circumference} ${circumference}`;
      ring.style.strokeDasharray = strokeDasharray;
    }

    function updateProteinGoal() {
      const goal = parseInt(document.getElementById('proteinGoalInput').value);
      if (goal && goal >= 50 && goal <= 300) {
        const s = loadState();
        s.proteinGoal = goal;
        saveState(s);
        updateProteinRing();
        document.getElementById('proteinGoalInput').value = '';
      }
    }

    // ---- Time Editing Functions ----
    function editTime(dow, itemKey, currentTime) {
      currentEditingTime = { dow, itemKey, currentTime };
      document.getElementById('timeInput').value = currentTime;
      document.getElementById('timeEditDialog').showModal();
    }

    function closeTimeDialog() {
      document.getElementById('timeEditDialog').close();
      currentEditingTime = null;
    }

    function saveTimeEdit() {
      if (!currentEditingTime) return;
      
      const newTime = document.getElementById('timeInput').value;
      const { dow, itemKey } = currentEditingTime;
      
      const s = loadState();
      if (!s.customTimes) s.customTimes = {};
      if (!s.customTimes[dow]) s.customTimes[dow] = {};
      s.customTimes[dow][itemKey] = newTime;
      saveState(s);
      
      renderTimeline();
      closeTimeDialog();
    }

    // ---- Smart Workout Suggestions ----
    function generateWorkoutSuggestions() {
      const dow = getDow();
      const s = loadState();
      const dk = todayKey();
      const checks = s.checks[dk] || {};
      const plan = WEEKLY_SCHEDULE[dow];
      const container = document.getElementById('workoutSuggestions');
      
      if (!container) return;
      
      container.innerHTML = '';
      
      const suggestions = [];
      
      // Check completion status
      const completedTasks = Object.values(checks).filter(Boolean).length;
      const totalTasks = plan.schedule.length;
      const completionRate = totalTasks > 0 ? completedTasks / totalTasks : 0;
      
      // Time-based suggestions
      const currentHour = new Date().getHours();
      
      if (completionRate < 0.3 && currentHour < 10) {
        suggestions.push({
          icon: '‚è∞',
          text: 'Start your day strong! Begin with hydration and your morning routine.',
          action: 'Get started',
          type: 'motivation'
        });
      }
      
      if (plan.workoutType === 'strength' && !checks[`${dow}-workout`]) {
        suggestions.push({
          icon: 'üèãÔ∏è',
          text: `Perfect time for ${plan.type}. Focus on compound movements today.`,
          action: 'View workout',
          type: 'workout'
        });
      }
      
      if (plan.workoutType === 'hiit' && currentHour >= 6 && currentHour <= 10) {
        suggestions.push({
          icon: '‚ö°',
          text: 'HIIT workouts are most effective in the morning. High energy awaits!',
          action: 'Start HIIT',
          type: 'workout'
        });
      }
      
      // Nutrition suggestions
      const proteinToday = s.logs[dk]?.protein || 0;
      const proteinGoal = s.proteinGoal || 120;
      
      if (proteinToday < proteinGoal * 0.5 && currentHour >= 12) {
        suggestions.push({
          icon: 'ü•©',
          text: `You're at ${proteinToday}g protein. Consider a protein-rich meal!`,
          action: '+30g protein',
          type: 'nutrition'
        });
      }
      
      // Hydration suggestions
      const waterToday = s.water[dk] || 0;
      const waterGoal = s.waterGoal || 8;
      
      if (waterToday < waterGoal * 0.6 && currentHour >= 14) {
        suggestions.push({
          icon: 'üíß',
          text: 'Hydration check! You might need more water to hit your goal.',
          action: '+2 glasses',
          type: 'hydration'
        });
      }
      
      // Recovery suggestions
      if (plan.workoutType === 'recovery') {
        suggestions.push({
          icon: 'üßò',
          text: 'Recovery day! Focus on mobility, stretching, or a peaceful walk.',
          action: 'Plan recovery',
          type: 'recovery'
        });
      }
      
      // High completion rate encouragement
      if (completionRate >= 0.8) {
        suggestions.push({
          icon: 'üéâ',
          text: 'Amazing progress today! You\'re crushing your goals.',
          action: 'Keep going!',
          type: 'celebration'
        });
      }
      
      // Render suggestions
      if (suggestions.length === 0) {
        container.innerHTML = '<div class="muted" style="text-align:center; padding:12px; font-size:0.9rem">You\'re doing great! Keep up the momentum.</div>';
        return;
      }
      
      suggestions.forEach(suggestion => {
        const item = document.createElement('div');
        item.className = 'suggestion-item';
        item.innerHTML = `
          <span class="suggestion-icon">${suggestion.icon}</span>
          <span class="suggestion-text">${suggestion.text}</span>
          <span class="suggestion-action">${suggestion.action}</span>
        `;
        
        // Add click handlers for actionable suggestions
        item.addEventListener('click', () => handleSuggestionClick(suggestion));
        
        container.appendChild(item);
      });
    }
    
    function handleSuggestionClick(suggestion) {
      switch (suggestion.type) {
        case 'nutrition':
          addQuickProtein(30);
          triggerSuccessFeedback('Protein added! üí™');
          break;
        case 'hydration':
          addQuickWater(2);
          triggerSuccessFeedback('Stay hydrated! üíß');
          break;
        case 'workout':
          // Could open workout details or mark as completed
          triggerSuccessFeedback('Let\'s get moving! üèãÔ∏è');
          break;
        default:
          triggerSuccessFeedback('Great choice! ‚ú®');
      }
      
      // Refresh suggestions after action
      setTimeout(() => generateWorkoutSuggestions(), 1000);
    }
    
    // ---- Google Fit Integration ----
    let googleFitConnected = false;
    
    function initGoogleFit() {
      // Load Google Fit API
      if (typeof gapi === 'undefined') {
        // Simulate API loading for demo
        console.log('Google Fit API would be loaded here');
      }
      
      const connectBtn = document.getElementById('connectGoogleFit');
      const statusDiv = document.getElementById('googleFitStatus');
      const stepsDiv = document.getElementById('stepsSync');
      
      connectBtn.addEventListener('click', async () => {
        try {
          connectBtn.textContent = 'Connecting...';
          connectBtn.disabled = true;
          
          // Simulate connection process
          await new Promise(resolve => setTimeout(resolve, 1500));
          
          // For demo purposes, simulate successful connection
          googleFitConnected = true;
          
          connectBtn.textContent = 'Connected ‚úì';
          connectBtn.classList.add('btn-success');
          statusDiv.innerHTML = '<span class="sync-status-connected">‚úÖ Connected! Steps will sync automatically</span>';
          stepsDiv.style.display = 'block';
          
          // Simulate fetching steps data
          const simulatedSteps = Math.floor(Math.random() * 5000) + 3000;
          document.getElementById('syncedSteps').textContent = simulatedSteps.toLocaleString();
          
          // Update logs with synced steps
          const s = loadState();
          const dk = todayKey();
          if (!s.logs[dk]) s.logs[dk] = {};
          s.logs[dk].steps = simulatedSteps;
          saveState(s);
          
          triggerSuccessFeedback('Google Fit connected! üéâ');
          
        } catch (error) {
          connectBtn.textContent = 'Retry';
          connectBtn.disabled = false;
          statusDiv.innerHTML = '<span class="sync-status-error">‚ùå Connection failed. Please try again.</span>';
          console.error('Google Fit connection error:', error);
        }
      });
    }
    
    // ---- Progress Sharing ----
    function generateProgressCard() {
      const s = loadState();
      const dk = todayKey();
      
      // Calculate stats for sharing
      const streak = s.streak || 0;
      const proteinToday = s.logs[dk]?.protein || 0;
      const proteinGoal = s.proteinGoal || 120;
      const waterToday = s.water[dk] || 0;
      const waterGoal = s.waterGoal || 8;
      
      // Get weekly completion
      const start = new Date(s.weekStart);
      let completedDays = 0;
      for (let i = 0; i < 7; i++) {
        const d = new Date(start);
        d.setDate(start.getDate() + i);
        const dateKey = d.toISOString().slice(0, 10);
        const checks = s.checks[dateKey] || {};
        const total = Object.keys(checks).length || 1;
        const done = Object.values(checks).filter(Boolean).length / total;
        if (done >= 0.8) completedDays++;
      }
      
      // Create shareable content
      const shareText = `üî• Fitness Update!\n\nüí™ ${streak} day streak\nü•§ Protein: ${proteinToday}g/${proteinGoal}g\nüíß Water: ${waterToday}/${waterGoal} glasses\nüìÖ Week progress: ${completedDays}/7 days\n\n#FitnessJourney #HealthGoals #Consistency`;
      
      // Create a beautiful visual card (simplified version)
      const cardHTML = `
        <div class="share-preview" style="text-align: center;">
          <h3 style="margin: 0 0 8px; color: var(--accent);">My Progress Today</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin: 12px 0;">
            <div><strong>${streak}</strong><br><span class="muted">Day Streak</span></div>
            <div><strong>${Math.round((proteinToday/proteinGoal)*100)}%</strong><br><span class="muted">Protein Goal</span></div>
            <div><strong>${waterToday}/${waterGoal}</strong><br><span class="muted">Water Glasses</span></div>
            <div><strong>${completedDays}/7</strong><br><span class="muted">Week Days</span></div>
          </div>
          <div class="achievement-badge" style="margin-top: 8px;">
            üèÜ ${getMotivationalMessage(streak, completedDays)}
          </div>
        </div>
      `;
      
      // Show sharing options
      if (navigator.share) {
        navigator.share({
          title: 'My Fitness Progress',
          text: shareText,
        }).catch(console.error);
      } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(shareText).then(() => {
          triggerSuccessFeedback('Progress copied to clipboard! üìã');
          
          // Show preview
          const preview = document.createElement('div');
          preview.innerHTML = cardHTML;
          preview.style.position = 'fixed';
          preview.style.top = '50%';
          preview.style.left = '50%';
          preview.style.transform = 'translate(-50%, -50%)';
          preview.style.background = 'var(--card)';
          preview.style.border = '2px solid var(--accent)';
          preview.style.borderRadius = '16px';
          preview.style.padding = '20px';
          preview.style.zIndex = '1000';
          preview.style.boxShadow = '0 8px 32px rgba(0,0,0,0.3)';
          
          document.body.appendChild(preview);
          
          setTimeout(() => {
            preview.remove();
          }, 3000);
        }).catch(() => {
          alert('Share text:\n\n' + shareText);
        });
      }
    }
    
    function getMotivationalMessage(streak, completedDays) {
      if (streak >= 30) return 'Consistency Master';
      if (streak >= 14) return 'Building Momentum';
      if (streak >= 7) return 'One Week Strong';
      if (completedDays >= 6) return 'Week Champion';
      if (completedDays >= 4) return 'Making Progress';
      return 'Getting Started';
    }
    
    // ---- Enhanced Feedback System ----
    function triggerSuccessFeedback(message) {
      // Visual feedback
      const feedback = document.createElement('div');
      feedback.innerHTML = message;
      feedback.style.position = 'fixed';
      feedback.style.top = '20px';
      feedback.style.right = '20px';
      feedback.style.background = 'var(--gradient-primary)';
      feedback.style.color = 'white';
      feedback.style.padding = '12px 16px';
      feedback.style.borderRadius = '8px';
      feedback.style.zIndex = '1000';
      feedback.style.fontWeight = '600';
      feedback.style.boxShadow = '0 4px 16px rgba(90, 127, 113, 0.4)';
      feedback.className = 'success-feedback';
      
      document.body.appendChild(feedback);
      
      setTimeout(() => {
        feedback.style.opacity = '0';
        feedback.style.transform = 'translateX(100px)';
        feedback.style.transition = 'all 0.3s ease';
        setTimeout(() => feedback.remove(), 300);
      }, 2000);
      
      // Haptic feedback for mobile
      if (navigator.vibrate) {
        navigator.vibrate([50, 30, 50]);
      }
    }
    
    function addSuccessAnimation(element) {
      element.classList.add('success-feedback');
      setTimeout(() => {
        element.classList.remove('success-feedback');
      }, 300);
    }
    function addQuickProtein(amount) {
      const s = loadState();
      const dk = todayKey();
      if (!s.logs[dk]) s.logs[dk] = {};
      const current = s.logs[dk].protein || 0;
      s.logs[dk].protein = current + amount;
      saveState(s);
      updateProteinRing();
      
      // Update log input if on log page
      const proteinInput = document.getElementById('logProtein');
      if (proteinInput && proteinInput.closest('.view').classList.contains('active')) {
        proteinInput.value = s.logs[dk].protein;
      }
    }

    function addQuickWater(glasses) {
      const s = loadState();
      const dk = todayKey();
      const current = s.water[dk] || 0;
      const newAmount = Math.max(0, Math.min(current + glasses, s.waterGoal));
      s.water[dk] = newAmount;
      saveState(s);
      renderWater();
      updateProgress();
    }

    function showQuickExerciseDialog() {
      document.getElementById('quickExerciseDialog').showModal();
    }

    function closeQuickExerciseDialog() {
      document.getElementById('quickExerciseDialog').close();
    }

    function saveQuickExercise() {
      const exerciseName = document.getElementById('quickExerciseName').value.trim();
      const weight = parseFloat(document.getElementById('quickExerciseWeight').value);
      
      if (!exerciseName || !weight || weight <= 0) {
        alert('Please enter both exercise name and weight');
        return;
      }
      
      const s = loadState();
      const dk = todayKey();
      
      if (!s.logs[dk]) s.logs[dk] = {};
      if (!s.logs[dk].exercises) s.logs[dk].exercises = {};
      
      const exerciseId = Date.now().toString(); // Use timestamp as unique ID
      s.logs[dk].exercises[exerciseId] = {
        name: exerciseName,
        maxWeight: weight
      };
      
      // Update PR if this is a new record
      if (!s.prs) s.prs = {};
      const exerciseKey = exerciseName.toLowerCase().replace(/\s+/g, '_');
      if (!s.prs[exerciseKey] || weight > (s.prs[exerciseKey].maxWeight || 0)) {
        s.prs[exerciseKey] = {
          name: exerciseName,
          maxWeight: weight,
          date: dk
        };
      }
      
      saveState(s);
      
      // Success feedback and UI updates
      triggerSuccessFeedback(`${exerciseName} logged: ${weight} lbs! üí™`);
      renderTodayExercises();
      
      // Clear form
      document.getElementById('quickExerciseName').value = '';
      document.getElementById('quickExerciseWeight').value = '';
      
      // Close dialog
      closeQuickExerciseDialog();
      
      console.log('Exercise saved:', { exerciseName, weight, exerciseId }); // Debug log
    }

    function renderTodayExercises() {
      const s = loadState();
      const dk = todayKey();
      const container = document.getElementById('todayExercises');
      
      if (!container) return;
      
      container.innerHTML = '';
      
      const todayExercises = s.logs[dk]?.exercises || {};
      
      if (Object.keys(todayExercises).length === 0) {
        container.innerHTML = '<div class="muted" style="text-align:center; padding:12px; font-size:0.9rem">No exercises logged today</div>';
        return;
      }
      
      Object.entries(todayExercises).forEach(([id, exercise]) => {
        const isPR = s.prs[id] && s.prs[id].maxWeight === exercise.maxWeight && s.prs[id].date === dk;
        
        const item = document.createElement('div');
        item.className = 'today-exercise-item';
        item.innerHTML = `
          <span>${exercise.name}</span>
          <span style="display:flex; align-items:center; gap:6px">
            <strong>${exercise.maxWeight} lbs</strong>
            ${isPR ? '<span class="pr-badge">PR!</span>' : ''}
          </span>
        `;
        container.appendChild(item);
      });
    }
    function addExercise() {
      document.getElementById('exerciseDialog').showModal();
    }

    function closeExerciseDialog() {
      document.getElementById('exerciseDialog').close();
    }

    function saveNewExercise() {
      const exerciseName = document.getElementById('exerciseNameInput').value.trim();
      if (!exerciseName) return;
      
      const exerciseId = Date.now().toString();
      renderExerciseEntry(exerciseId, exerciseName, []);
      document.getElementById('exerciseNameInput').value = '';
      closeExerciseDialog();
    }

    function renderExerciseEntry(exerciseId, exerciseName, maxWeight = '') {
      const container = document.getElementById('exerciseLog');
      const entry = document.createElement('div');
      entry.className = 'exercise-entry-simple';
      entry.id = `exercise-${exerciseId}`;
      
      entry.innerHTML = `
        <input type="text" class="exercise-weight-input" value="${exerciseName}" placeholder="Exercise name" onchange="updateExerciseName('${exerciseId}', this.value)">
        <input type="number" class="exercise-weight-input" value="${maxWeight}" placeholder="Max weight" step="0.5" onchange="updateExerciseWeight('${exerciseId}', this.value)">
        <button class="btn small" onclick="removeExercise('${exerciseId}')" style="background:var(--warning); color:white">√ó</button>
      `;
      
      container.appendChild(entry);
    }

    function updateExerciseName(exerciseId, name) {
      // Update will be handled when saving
    }

    function updateExerciseWeight(exerciseId, weight) {
      // Update will be handled when saving
    }

    function addSet(exerciseId, setData = null) {
      const container = document.getElementById(`sets-${exerciseId}`);
      const setIndex = container.children.length; // -1 for header, but +1 for new set = 0 net change
      
      const setRow = document.createElement('div');
      setRow.className = 'set-row';
      setRow.innerHTML = `
        <div>${setIndex}</div>
        <input type="number" class="set-input" placeholder="0" step="0.5" value="${setData?.weight || ''}" onchange="updateSetData('${exerciseId}', ${setIndex - 1}, 'weight', this.value)">
        <input type="number" class="set-input" placeholder="0" step="1" value="${setData?.reps || ''}" onchange="updateSetData('${exerciseId}', ${setIndex - 1}, 'reps', this.value)">
        <input type="number" class="set-input" placeholder="0" min="1" max="10" step="0.5" value="${setData?.rpe || ''}" onchange="updateSetData('${exerciseId}', ${setIndex - 1}, 'rpe', this.value)">
        <button class="remove-set-btn" onclick="removeSet('${exerciseId}', ${setIndex - 1})">√ó</button>
      `;
      
      container.appendChild(setRow);
    }

    function removeSet(exerciseId, setIndex) {
      const container = document.getElementById(`sets-${exerciseId}`);
      if (container.children.length > 2) { // Keep at least header + 1 set
        container.children[setIndex + 1].remove(); // +1 to account for header
        updateSetNumbers(exerciseId);
      }
    }

    function updateSetNumbers(exerciseId) {
      const container = document.getElementById(`sets-${exerciseId}`);
      Array.from(container.children).forEach((row, index) => {
        if (index > 0) { // Skip header
          row.children[0].textContent = index;
        }
      });
    }

    function removeExercise(exerciseId) {
      document.getElementById(`exercise-${exerciseId}`).remove();
    }

    function updateSetData(exerciseId, setIndex, field, value) {
      // This could be used to auto-calculate PRs or save data in real-time
      // For now, data will be saved when the save button is clicked
    }

    function getExerciseData() {
      const exercises = {};
      const exerciseEntries = document.querySelectorAll('.exercise-entry-simple');
      
      exerciseEntries.forEach((entry, index) => {
        const exerciseId = entry.id.replace('exercise-', '') || `exercise_${index}`;
        const inputs = entry.querySelectorAll('.exercise-weight-input');
        const exerciseName = inputs[0].value.trim();
        const maxWeight = parseFloat(inputs[1].value) || 0;
        
        if (exerciseName && maxWeight > 0) {
          exercises[exerciseId] = {
            name: exerciseName,
            maxWeight: maxWeight
          };
        }
      });
      
      return exercises;
    }

    function calculatePRs(exercises) {
      const prs = {};
      
      Object.values(exercises).forEach(exercise => {
        const { name, maxWeight } = exercise;
        const exerciseId = name.toLowerCase().replace(/\s+/g, '_');
        
        prs[exerciseId] = {
          name: name,
          maxWeight: maxWeight,
          date: todayKey()
        };
      });
      
      return prs;
    }

    // ---- Weekly Metrics Functions ----
    function saveWeeklyMetrics() {
      const weight = parseFloat(document.getElementById('weeklyWeight').value);
      const waist = parseFloat(document.getElementById('weeklyWaist').value);
      const hips = parseFloat(document.getElementById('weeklyHips').value);
      
      if (!weight && !waist && !hips) {
        alert('Please enter at least one measurement');
        return;
      }
      
      const s = loadState();
      const dk = todayKey();
      
      if (!s.logs[dk]) s.logs[dk] = {};
      if (weight) s.logs[dk].weight = weight;
      if (waist) s.logs[dk].waist = waist;
      if (hips) s.logs[dk].hips = hips;
      
      saveState(s);
      
      // Clear inputs
      document.getElementById('weeklyWeight').value = '';
      document.getElementById('weeklyWaist').value = '';
      document.getElementById('weeklyHips').value = '';
      
      triggerSuccessFeedback('Weekly metrics saved! üìè‚ú®');
      renderProgress();
    }

    // ---- Rendering Today ----
    function renderHeader(){
      const dow=getDow(); const meta=WEEKLY_SCHEDULE[dow];
      document.getElementById('dayName').textContent=DAY_NAMES[dow];
      document.getElementById('dayType').textContent = `${ICONS[meta.workoutType]} ${meta.type} ‚Ä¢ ${meta.dose ? 'Dose day' : 'No dose'}`;
      const s=loadState(); document.getElementById('streakCount').textContent = s.streak||0;
      const start=new Date(s.weekStart); const diffDays = Math.floor((Date.now()-start.getTime())/86400000);
      const weekNum = Math.floor(diffDays/7)+1; document.getElementById('weekLabel').textContent = `Week ${Math.max(1, weekNum)}`;
    }

    function getTimeForItem(dow, itemKey, defaultTime) {
      const s = loadState();
      return s.customTimes?.[dow]?.[itemKey] || defaultTime;
    }

    function renderTimeline(){
      const timeline=document.getElementById('timeline'); timeline.innerHTML='';
      const s=loadState(); const dk=todayKey(); const checks=s.checks[dk]||{}; const dow=getDow(); const plan=WEEKLY_SCHEDULE[dow].schedule;
      
      plan.forEach(item=>{
        const li=document.createElement('li'); const div=document.createElement('div'); div.className='task';
        const id=`${dow}-${item.key}`; const cb=document.createElement('input'); cb.type='checkbox'; cb.id=id; cb.checked=!!checks[id];
        cb.addEventListener('change',()=>{ const st=loadState(); st.checks[dk]=st.checks[dk]||{}; st.checks[dk][id]=cb.checked; saveState(st); updateProgress(); renderWeek(); });
        
        const currentTime = getTimeForItem(dow, item.key, item.time);
        const lbl=document.createElement('label'); lbl.setAttribute('for', id);
        lbl.innerHTML = `<div class="task-time" onclick="editTime(${dow}, '${item.key}', '${currentTime}')">${toHuman(currentTime)}</div><div class="task-title">${item.title}</div><div class="task-note">${item.note||''}</div>${item.details?`<div class="task-details"><div class="workout-details"><strong>Workout Details:</strong><br>${item.details}</div></div>`:''}`;
        div.append(cb,lbl); li.append(div); timeline.append(li);
      });
    }

    function renderWater(){
      const s=loadState(); const dk=todayKey(); const cur=s.water[dk]||0; document.getElementById('waterCurrent').textContent=cur;
      const wrap=document.getElementById('waterDrops'); wrap.innerHTML='';
      for(let i=0;i<s.waterGoal;i++){ const b=document.createElement('button'); b.type='button'; b.className='drop'+(i<cur?' filled':''); b.addEventListener('click',()=>{ const st=loadState(); const c=st.water[dk]||0; st.water[dk]=(i<c)?i:i+1; saveState(st); renderWater(); updateProgress(); }); wrap.append(b); }
      document.getElementById('waterProgress').style.width = ((cur/s.waterGoal)*100).toFixed(0)+'%';
    }

    function renderWeek(){
      const s=loadState(); const weekOverview=document.getElementById('weekOverview'); weekOverview.innerHTML=''; const weekSchedule=document.getElementById('weekSchedule'); weekSchedule.innerHTML='';
      const start=new Date(s.weekStart); let doneDays=0;
      for(let i=0;i<7;i++){
        const d=new Date(start); d.setDate(start.getDate()+i); const dateKey=d.toISOString().slice(0,10); const dow=d.getDay();
        const plan=WEEKLY_SCHEDULE[dow]; const checks=s.checks[dateKey]||{}; const completed=Object.values(checks).filter(Boolean).length; const total=plan.schedule.length; const water=(s.water[dateKey]||0)/(s.waterGoal||8);
        const pct = Math.min(1, (total?completed/total:0)*0.8 + water*0.2);
        const row=document.createElement('li'); row.className='card'; if(new Date().toDateString()===d.toDateString()){ row.classList.add('today-highlight'); }
        row.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><div><strong>${DAY_NAMES[dow]}</strong> ‚Ä¢ ${ICONS[plan.workoutType]} ${plan.type} ‚Ä¢ ${plan.dose?'Dose':'No dose'}</div><div style="min-width:46px;text-align:right"><strong>${Math.round(pct*100)}%</strong></div></div><div class="progress-bar"><div class="progress-fill" style="width:${(pct*100).toFixed(0)}%"></div></div>`;
        weekOverview.append(row);
        
        const sched=document.createElement('div'); sched.className='card'; if(new Date().toDateString()===d.toDateString()){ sched.classList.add('today-highlight'); }
        sched.innerHTML=`<h3 style="margin:0 0 6px">${DAY_NAMES[dow]} ‚Äì ${plan.type}</h3>`;
        plan.schedule.forEach(item=>{ const line=document.createElement('div'); line.className='muted'; line.style.margin='2px 0'; line.textContent = `${toHuman(getTimeForItem(dow, item.key, item.time))} ‚Ä¢ ${item.title}`; sched.append(line); });
        weekSchedule.append(sched);
        if(pct>=0.9) doneDays++;
      }
      const pctWeek = Math.round((doneDays/7)*100); document.getElementById('weekCompleted').textContent=doneDays; document.getElementById('weekPercentage').textContent=pctWeek+'%';
    }

    function updateProgress(){
      const s=loadState(); const dk=todayKey(); const dow=getDow(); const plan=WEEKLY_SCHEDULE[dow];
      const checks=s.checks[dk]||{}; const completed=Object.values(checks).filter(Boolean).length; const total=plan.schedule.length; const water=(s.water[dk]||0)/(s.waterGoal||8);
      const pct=Math.min(1, (total?completed/total:0)*0.8 + water*0.2);
      if(pct>=0.9 && !s._markedToday){ s._markedToday=true; s.streak=(s.streak||0)+1; saveState(s); document.getElementById('streakCount').textContent=s.streak; }
    }

    // ---- Log tab ----
    function pad(n){ return String(n).padStart(2,'0') }
    function todayISO(){ const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}` }

    function loadLog(dateKey){
      const s=loadState(); const L=s.logs[dateKey]||{};
      const set=(id,v)=>{ const el=document.getElementById(id); if(el) el.value = (v ?? ''); };
      set('logDate', dateKey);
      set('logWeight', L.weight); set('logWaist', L.waist); set('logHips', L.hips); set('logChest', L.chest); set('logThigh', L.thigh); set('logArm', L.arm);
      set('logProtein', L.protein); set('logSleep', L.sleep); set('logSteps', L.steps); set('logMood', L.mood);
      
      // Load exercises for this date
      const exerciseLog = document.getElementById('exerciseLog');
      exerciseLog.innerHTML = '';
      if (L.exercises) {
        Object.entries(L.exercises).forEach(([exerciseId, exercise]) => {
          renderExerciseEntry(exerciseId, exercise.name, exercise.sets);
        });
      }
      
      updateProteinRing();
    }

    function saveLog(){
      const dateKey=document.getElementById('logDate').value || todayISO();
      const get=(id)=>{ const v=document.getElementById(id).value; return v===''?undefined:(isNaN(v)?v:parseFloat(v)); };
      
      const exercises = getExerciseData();
      const prs = calculatePRs(exercises);
      
      const L={ weight:get('logWeight'), waist:get('logWaist'), hips:get('logHips'), chest:get('logChest'), thigh:get('logThigh'), arm:get('logArm'),
                protein:get('logProtein'), sleep:get('logSleep'), steps:get('logSteps'), mood:get('logMood'), exercises: exercises };
      
      const s=loadState(); 
      s.logs[dateKey]=Object.assign({}, s.logs[dateKey]||{}, L); 
      
      // Update PRs
      if (!s.prs) s.prs = {};
      Object.entries(prs).forEach(([key, pr]) => {
        if (!s.prs[key] || pr.maxWeight > (s.prs[key].maxWeight || 0)) {
          s.prs[key] = pr;
        }
      });
      
      saveState(s); 
      updateProteinRing();
      triggerSuccessFeedback('Log saved successfully! üìä'); 
      renderProgress();
    }

    function initLog(){
      const d=todayISO(); document.getElementById('logDate').value=d; loadLog(d);
      document.getElementById('logDate').addEventListener('change', e=>loadLog(e.target.value));
      document.getElementById('saveLogBtn').addEventListener('click', saveLog);
      document.getElementById('addExerciseBtn').addEventListener('click', addExercise);
      
      document.getElementById('exportBtn').addEventListener('click', ()=>{
        const data = loadState();
        const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
        const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='morning-fat-loss-backup.json'; a.click();
        setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
      });
      document.getElementById('importInput').addEventListener('change', (e)=>{
        const file=e.target.files[0]; if(!file) return;
        const reader=new FileReader(); reader.onload=()=>{ try{ localStorage.setItem('mfl_state_v23b', reader.result); alert('Imported ‚úî'); renderAll(); renderWeek(); renderProgress(); }catch(err){ alert('Import failed'); } }; reader.readAsText(file);
      });
    }

    // ---- Progress tab ----
    function drawLineChart(canvasId, points, color){
      const cv=document.getElementById(canvasId); if(!cv) return; const ctx=cv.getContext('2d'); const w=cv.width, h=cv.height;
      ctx.clearRect(0,0,w,h);
      ctx.strokeStyle='rgba(0,0,0,0.1)'; ctx.lineWidth=1;
      ctx.beginPath(); ctx.moveTo(32,8); ctx.lineTo(32,h-24); ctx.lineTo(w-8,h-24); ctx.stroke();
      if(points.length<2) return;
      const xs=points.map(p=>p.x), ys=points.map(p=>p.y);
      const minX=Math.min(...xs), maxX=Math.max(...xs), minY=Math.min(...ys), maxY=Math.max(...ys);
      const px=x=>32 + ( (x-minX) / Math.max(1,(maxX-minX)) ) * (w-40);
      const py=y=> (h-24) - ( (y-minY) / Math.max(1,(maxY-minY)) ) * (h-40);
      ctx.strokeStyle=color||'#5a7f71'; ctx.lineWidth=2; ctx.beginPath();
      points.forEach((p,i)=>{ const X=px(p.x), Y=py(p.y); if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y); }); ctx.stroke();
      ctx.fillStyle=color||'#5a7f71'; points.forEach(p=>{ const X=px(p.x), Y=py(p.y); ctx.beginPath(); ctx.arc(X,Y,3,0,Math.PI*2); ctx.fill(); });
    }

    function daysSinceEpoch(iso){ return Math.floor(new Date(iso).getTime()/86400000); }
    function calcChange(arr){ if(arr.length<2) return '‚Äî'; const first=arr[0].y, last=arr[arr.length-1].y; const diff = last-first; const sign = diff>0?'+':''; return `${sign}${diff.toFixed(1)}`; }
    function getLogsSorted(){ const s=loadState(); const entries=Object.entries(s.logs||{}).sort((a,b)=>new Date(a[0])-new Date(b[0])); return entries; }

    function renderPRs() {
      const s = loadState();
      const prGrid = document.getElementById('prGrid');
      prGrid.innerHTML = '';
      
      if (!s.prs || Object.keys(s.prs).length === 0) {
        prGrid.innerHTML = '<div class="muted" style="grid-column: 1/-1; text-align: center; padding: 20px;">No personal records yet. Start logging workouts!</div>';
        return;
      }
      
      Object.entries(s.prs).forEach(([key, pr]) => {
        const card = document.createElement('div');
        card.className = 'pr-card';
        card.innerHTML = `
          <div class="pr-lift">${pr.name}</div>
          <div class="pr-value">${pr.maxWeight} lb</div>
          <div class="pr-date">${new Date(pr.date).toLocaleDateString()}</div>
        `;
        prGrid.appendChild(card);
      });
    }

    function renderProgress(){
      const entries=getLogsSorted();
      const wPts = entries.filter(([d,L])=>L.weight!=null).map(([d,L])=>({x:daysSinceEpoch(d), y:Number(L.weight)}));
      drawLineChart('chartWeight', wPts, getComputedStyle(document.documentElement).getPropertyValue('--accent').trim());
      document.getElementById('weightChange').textContent = wPts.length?`Œî ${calcChange(wPts)} lb`:'‚Äî';
      const waistPts = entries.filter(([d,L])=>L.waist!=null).map(([d,L])=>({x:daysSinceEpoch(d), y:Number(L.waist)}));
      drawLineChart('chartWaist', waistPts, getComputedStyle(document.documentElement).getPropertyValue('--drop').trim());
      document.getElementById('waistChange').textContent = waistPts.length?`Œî ${calcChange(waistPts)} in`:'‚Äî';

      const s=loadState(); const start=new Date(s.weekStart); const end=new Date(start); end.setDate(start.getDate()+7);
      let workouts=0, protein=0, proteinDays=0, sleep=0, sleepDays=0, water=0, waterDays=0;
      for(let i=0;i<7;i++){
        const d=new Date(start); d.setDate(start.getDate()+i); const dk=d.toISOString().slice(0,10);
        const checks=s.checks[dk]||{}; const total=(Object.keys(checks).length||1); const done=(Object.values(checks).filter(Boolean).length)/(total);
        if(done>=0.6) workouts++;
        const L=s.logs[dk]; if(L){
          if(L.protein){ protein+=Number(L.protein); proteinDays++; }
          if(L.sleep){ sleep+=Number(L.sleep); sleepDays++; }
        }
        if(s.water[dk]!=null){ water+=Number(s.water[dk]); waterDays++; }
      }
      document.getElementById('sumWorkouts').textContent = `${workouts}/7`;
      document.getElementById('sumProtein').textContent = proteinDays? `${Math.round(protein/proteinDays)} g` : '‚Äî';
      document.getElementById('sumSleep').textContent = sleepDays? (sleep/sleepDays).toFixed(1)+' h' : '‚Äî';
      document.getElementById('sumWater').textContent = waterDays? (water/waterDays).toFixed(1)+' cups' : '‚Äî';

      renderPRs();
    }

    // ---- Navigation ----
    document.querySelectorAll('.tabbar button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tabbar button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
        document.getElementById(btn.dataset.target).classList.add('active');
        window.scrollTo({top:0, behavior:'smooth'});
        if(btn.dataset.target==='view-week'){ renderWeek(); }
        if(btn.dataset.target==='view-progress'){ renderProgress(); }
        if(btn.dataset.target==='view-log'){ initLog(); }
      });
    });

    // Weekly metrics save button
    document.getElementById('saveWeeklyMetrics').addEventListener('click', saveWeeklyMetrics);

    // Weekday picker
    document.querySelectorAll('.chip').forEach(chip=>{
      chip.addEventListener('click', ()=>{
        document.querySelectorAll('.chip').forEach(c=>c.setAttribute('aria-pressed','false'));
        chip.setAttribute('aria-pressed','true'); renderAll();
      });
    });

    function setPickerToToday(){
      const dow=new Date().getDay(); const chip=document.querySelector(`.chip[data-day="${dow}"]`);
      if(chip){ chip.setAttribute('aria-pressed','true'); chip.classList.add('today-chip'); }
    }

    function renderAll(){ 
      renderHeader(); 
      renderTimeline(); 
      renderWater(); 
      updateProteinRing();
      renderTodayExercises();
      updateProgress(); 
    }

    // ---- Dialog Event Listeners ----
    document.getElementById('timeEditDialog').addEventListener('close', (e) => {
      if (e.target.returnValue === 'default') {
        saveTimeEdit();
      }
    });

    document.getElementById('exerciseDialog').addEventListener('close', (e) => {
      if (e.target.returnValue === 'default') {
        saveNewExercise();
      }
    });

    // Note: quickExerciseDialog uses form onsubmit handler, no close event listener needed

    // Initialize premium visual features
    function initPremiumFeatures() {
      // Enhanced task completion feedback
      document.addEventListener('change', (e) => {
        if (e.target.type === 'checkbox' && e.target.closest('.task')) {
          if (e.target.checked) {
            triggerSuccessFeedback('Task completed! ‚úÖ');
            addSuccessAnimation(e.target.closest('.task'));
          }
        }
      });
      
      // Protein goal achievement celebration
      const originalUpdateProteinRing = updateProteinRing;
      updateProteinRing = function() {
        const s = loadState();
        const dk = todayKey();
        const current = s.logs[dk]?.protein || 0;
        const goal = s.proteinGoal || 120;
        const wasAtGoal = document.getElementById('proteinCurrent').textContent.replace('g', '') >= goal;
        
        originalUpdateProteinRing();
        
        // Celebrate reaching protein goal
        if (current >= goal && !wasAtGoal) {
          setTimeout(() => {
            triggerSuccessFeedback('Protein goal achieved! üéâ');
            const ringElement = document.querySelector('.protein-ring');
            addSuccessAnimation(ringElement);
          }, 300);
        }
      };
    }

    // Initialize protein goal input
    function initProteinGoal() {
      const s = loadState();
      document.getElementById('proteinGoalInput').placeholder = s.proteinGoal || 120;
    }

    // Init
    initDefaults(); 
    setPickerToToday(); 
    initProteinGoal();
    initPremiumFeatures();
    renderAll(); 
    renderWeek(); 
    renderProgress();
    
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('./service-worker.js').catch(()=>{}); }
  </script>
</body>
</html>
